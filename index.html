<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="google" content="notranslate" />

  <title>F-CAFE</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <!-- REMOVE any old tailwind *.css link and add this exactly -->
<script src="https://cdn.tailwindcss.com"></script>

</head>
<body class="bg-neutral-50 text-neutral-900" translate="no">
  <main class="max-w-3xl mx-auto p-4">
    <header class="mb-4">
      <h1 class="text-2xl font-bold">Đặt hàng giao tận nơi</h1>
      <p class="text-sm text-neutral-600">Chọn món, nhập địa chỉ, xác nhận đơn.</p>
    </header>

    <!-- MENU -->
    <section id="menu" class="grid grid-cols-1 gap-3"></section>

    <!-- CART -->
    <section class="mt-6 p-4 bg-white rounded-xl shadow">
      <div class="flex items-center justify-between">
        <h2 class="font-semibold">Giỏ hàng</h2>
        <button id="clearCart" class="text-sm underline">Xoá giỏ</button>
      </div>
      <div id="cart" class="mt-2"></div>
      <div class="mt-2 flex justify-between font-medium">
        <span>Tổng tạm</span>
        <span id="subtotal">0 đ</span>
      </div>
    </section>

    <!-- DELIVERY & CHECKOUT -->
    <section class="mt-6 p-4 bg-white rounded-xl shadow">
      <h2 class="font-semibold mb-2">Thông tin giao hàng</h2>
      <form id="checkoutForm" class="grid gap-3">
        <input name="name" placeholder="Họ tên" class="border p-2 rounded" required />
        <input name="phone" placeholder="SĐT (ví dụ 09xxxxxxxx)" class="border p-2 rounded" required />
        <input name="street" placeholder="Số nhà, đường" class="border p-2 rounded" required />
        <div class="grid grid-cols-3 gap-2">
          <input name="ward" placeholder="Phường/Xã" class="border p-2 rounded" required />
          <input name="district" placeholder="Quận/Huyện" class="border p-2 rounded" required />
          <input name="province" placeholder="Tỉnh/TP" class="border p-2 rounded" required />
        </div>
        <textarea name="note" placeholder="Ghi chú giao hàng (tuỳ chọn)" class="border p-2 rounded"></textarea>
        <label class="inline-flex items-center gap-2">
          <input type="checkbox" name="consent" />
          <span>Tôi đồng ý nhận khuyến mãi qua SMS/Email</span>
        </label>
        <button class="bg-black text-white px-4 py-2 rounded">Đặt hàng</button>
      </form>
      <p id="resultMsg" class="mt-3 text-green-700 font-medium hidden">Đã đặt hàng! Cảm ơn bạn.</p>
    </section>
  </main>

<script>
/** ====== CONFIG (REPLACE THESE TWO LINES) ====== **/
const SUPABASE_URL = 'https://peenohpyubshzxgzzkhx.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBlZW5vaHB5dWJzaHp4Z3p6a2h4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg5OTczOTYsImV4cCI6MjA3NDU3MzM5Nn0.5PJYRCGyhM-E16yJrU5W_kBeDQgaJiine4j_cS9gKoU';
/** ============================================== **/

const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
const state = { cart: [] };

function money(v){ return (v).toLocaleString('vi-VN') + ' đ'; }

async function loadMenu(){
  const { data, error } = await sb.from('products')
    .select('*')
    .eq('is_active', true)
    .order('category', { ascending: true });
  if(error){ alert('Không tải được menu'); return; }

  // group by category
  const groups = data.reduce((acc,p)=>{
    (acc[p.category] ||= []).push(p);
    return acc;
  },{});

  const container = document.getElementById('menu');
  container.innerHTML = '';
  Object.entries(groups).forEach(([cat, items])=>{
    const sec = document.createElement('div');
    sec.className = 'bg-white rounded-xl shadow';
    sec.innerHTML = `
      <div class="px-4 py-3 border-b font-semibold">${cat}</div>
      <div class="p-3 grid gap-2"></div>
    `;
    const list = sec.querySelector('div.grid');
    items.forEach(p=>{
      const row = document.createElement('div');
      row.className = 'flex items-center justify-between';
      row.innerHTML = `
        <div>
          <div class="font-medium">${p.name_vi || p.name}</div>
          <div class="text-sm text-neutral-500">${money(p.price)}</div>
        </div>
        <button class="px-3 py-1 bg-neutral-900 text-white rounded">Thêm</button>
      `;
      row.querySelector('button').onclick = ()=>{
        const f = state.cart.find(i=>i.id===p.id);
        if(f) f.qty += 1;
        else state.cart.push({ id:p.id, name:p.name_vi||p.name, price:p.price, qty:1 });
        renderCart();
      };
      list.appendChild(row);
    });
    container.appendChild(sec);
  });
}

function renderCart(){
  const wrap = document.getElementById('cart');
  wrap.innerHTML = '';
  let sum = 0;
  state.cart.forEach((i, idx)=>{
    sum += i.price*i.qty;
    const row = document.createElement('div');
    row.className = 'flex items-center justify-between py-1';
    row.innerHTML = `
      <span>${i.name} × ${i.qty}</span>
      <div class="flex items-center gap-2">
        <button class="px-2 py-0.5 border rounded" data-idx="${idx}" data-op="-">-</button>
        <button class="px-2 py-0.5 border rounded" data-idx="${idx}" data-op="+">+</button>
        <span>${money(i.price*i.qty)}</span>
      </div>
    `;
    wrap.appendChild(row);
  });
  wrap.querySelectorAll('button').forEach(btn=>{
    btn.onclick = ()=>{
      const idx = +btn.dataset.idx;
      const op = btn.dataset.op;
      if(op==='-' && state.cart[idx].qty>1) state.cart[idx].qty -= 1;
      else if(op==='+' ) state.cart[idx].qty += 1;
      renderCart();
    };
  });
  document.getElementById('subtotal').textContent = money(sum);
}

document.getElementById('clearCart').onclick = ()=>{
  state.cart = [];
  renderCart();
};

document.getElementById('checkoutForm').addEventListener('submit', async (e)=>{
  e.preventDefault();
  if(state.cart.length===0){ alert('Giỏ hàng trống'); return; }

  const fd = new FormData(e.target);
  const name = fd.get('name').trim();
  const phone = fd.get('phone').trim();
  const street = fd.get('street').trim();
  const ward = fd.get('ward').trim();
  const district = fd.get('district').trim();
  const province = fd.get('province').trim();
  const note = (fd.get('note')||'').trim();
  const consent = !!fd.get('consent');

  // 1) Upsert customer (insert, or fetch by phone if unique violation)
  let { data: cRow, error: cErr } = await sb.from('customers')
    .insert({ name, phone })
    .select('id')
    .single();
  if(cErr && String(cErr.message).includes('duplicate key')){
    const { data: existing } = await sb.from('customers').select('id').eq('phone', phone).single();
    cRow = existing;
  } else if(cErr) {
    alert('Lỗi khi lưu khách hàng');
    return;
  }

  // 2) Consent (optional)
  if(consent){
    await sb.from('marketing_consents').insert({
      customer_id: cRow.id,
      consent: true,
      channel: 'sms',
      source: 'checkout'
    });
  }

  // 3) Create order + items
  const addressSnapshot = { name, phone, street, ward, district, province, note };
  const subtotal = state.cart.reduce((a,i)=>a+i.price*i.qty,0);
  const delivery_fee = 0;
  const total = subtotal + delivery_fee;

  const { data: order, error: oErr } = await sb.from('orders')
    .insert({
      customer_id: cRow.id,
      address_snapshot: addressSnapshot,
      subtotal, delivery_fee, total, status: 'pending',
      note
    })
    .select('id')
    .single();
  if(oErr){ alert('Lỗi tạo đơn hàng'); return; }

  const items = state.cart.map(i=>({
    order_id: order.id,
    product_id: i.id,
    name: i.name,
    unit_price: i.price,
    qty: i.qty
  }));
  const { error: iErr } = await sb.from('order_items').insert(items);
  if(iErr){ alert('Lỗi lưu món'); return; }

  // 4) Reset UI
  state.cart = [];
  renderCart();
  e.target.reset();
  document.getElementById('resultMsg').classList.remove('hidden');
});

loadMenu();
</script>
</body>
</html>
