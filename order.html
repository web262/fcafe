<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>CAFE ‚Äî CACAO | ƒê·∫∑t h√†ng</title>
  <meta name="description" content="ƒê·∫∑t ƒë·ªì u·ªëng v√† ƒë·ªì ƒÉn t·ª´ CAFE ‚Äî CACAO. Thanh to√°n nhanh, giao t·∫≠n n∆°i.">
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><rect width=%22100%22 height=%22100%22 rx=%2218%22 fill=%22000%22/><text x=%2250%22 y=%2262%22 font-size=%2260%22 text-anchor=%22middle%22 fill=%22%23fff%22 font-family=%22Inter,Arial%22>C</text></svg>">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    .card{transition:transform .16s ease, box-shadow .16s ease}
    .card:hover{transform:translateY(-2px); box-shadow:0 10px 22px rgba(0,0,0,.08)}
    .shadow-soft{box-shadow:0 1px 0 rgba(20,20,20,.05), 0 8px 32px rgba(0,0,0,.06)}
    .pill{transition:background .15s ease, color .15s ease}
  </style>
</head>
<body class="bg-neutral-50 text-neutral-900" translate="no">
  <!-- NAV -->
  <header class="sticky top-0 z-40 backdrop-blur bg-white/80 border-b">
    <div class="max-w-screen-2xl mx-auto px-4 h-14 flex items-center justify-between">
      <a href="index.html" class="flex items-center gap-2">
        <div class="h-8 w-8 rounded-xl bg-black text-white grid place-items-center font-bold">C</div>
        <div>
          <div class="font-semibold tracking-wide">CAFE ‚Äî CACAO</div>
          <div class="text-xs text-neutral-500">ƒê·∫∑t h√†ng tr·ª±c tuy·∫øn</div>
        </div>
      </a>
      <div class="flex items-center gap-2">
        <button id="btnVI" class="px-2 py-1 rounded-lg text-sm font-medium border">VI</button>
        <button id="btnEN" class="px-2 py-1 rounded-lg text-sm font-medium border">EN</button>
      </div>
    </div>
  </header>

  <main class="max-w-screen-2xl mx-auto px-4 py-4">
    <div class="grid lg:grid-cols-[1fr_360px] gap-6">
      <!-- LEFT: menu -->
      <section>
        <!-- Filters -->
        <div class="rounded-2xl bg-white border shadow-soft p-3">
          <div class="flex flex-col sm:flex-row sm:items-center gap-3">
            <div class="flex gap-2">
              <button data-cat="Food"   class="cat pill px-3 py-1.5 rounded-lg border bg-white font-medium">üçú Food</button>
              <button data-cat="Drinks" class="cat pill px-3 py-1.5 rounded-lg border bg-white font-medium">ü•§ Drinks</button>
              <button data-cat="All"    class="cat pill px-3 py-1.5 rounded-lg border bg-white">T·∫•t c·∫£</button>
            </div>
            <div class="flex-1"></div>
            <div class="relative w-full sm:w-80">
              <input id="search" type="search" class="w-full rounded-xl border px-3 py-2 pr-9" placeholder="T√¨m m√≥n, v√≠ d·ª•: c√† ph√™, x√¥i, b√°nh m√¨‚Ä¶">
              <svg class="absolute right-3 top-2.5" width="20" height="20" viewBox="0 0 24 24" fill="none"><path d="m21 21-4.35-4.35M10.5 18a7.5 7.5 0 1 1 0-15 7.5 7.5 0 0 1 0 15Z" stroke="currentColor" stroke-width="1.6"/></svg>
            </div>
          </div>

          <!-- Subcategory pills (dynamic) -->
          <div id="subcats" class="mt-3 flex flex-wrap gap-2"></div>
        </div>

        <!-- Product grid -->
        <div id="grid" class="mt-4 grid sm:grid-cols-2 xl:grid-cols-3 gap-4">
          <!-- skeletons -->
          <div class="rounded-2xl bg-white border p-4 animate-pulse">
            <div class="w-full h-36 bg-neutral-100 rounded-xl"></div>
            <div class="h-4 bg-neutral-100 rounded mt-3 w-4/5"></div>
            <div class="h-3 bg-neutral-100 rounded mt-2 w-1/2"></div>
            <div class="mt-3 h-9 bg-neutral-100 rounded"></div>
          </div>
          <div class="rounded-2xl bg-white border p-4 animate-pulse">
            <div class="w-full h-36 bg-neutral-100 rounded-xl"></div>
            <div class="h-4 bg-neutral-100 rounded mt-3 w-4/5"></div>
            <div class="h-3 bg-neutral-100 rounded mt-2 w-1/2"></div>
            <div class="mt-3 h-9 bg-neutral-100 rounded"></div>
          </div>
          <div class="rounded-2xl bg-white border p-4 animate-pulse">
            <div class="w-full h-36 bg-neutral-100 rounded-xl"></div>
            <div class="h-4 bg-neutral-100 rounded mt-3 w-4/5"></div>
            <div class="h-3 bg-neutral-100 rounded mt-2 w-1/2"></div>
            <div class="mt-3 h-9 bg-neutral-100 rounded"></div>
          </div>
        </div>

        <div id="empty" class="hidden mt-8 text-center text-neutral-500">Kh√¥ng t√¨m th·∫•y m√≥n ph√π h·ª£p.</div>
        <div id="error" class="hidden mt-8 text-center text-red-600">Kh√¥ng t·∫£i ƒë∆∞·ª£c d·ªØ li·ªáu. Vui l√≤ng th·ª≠ l·∫°i sau.</div>
      </section>

      <!-- RIGHT: cart + checkout -->
      <aside class="space-y-4">
        <div class="rounded-2xl bg-white border shadow-soft p-4">
          <div class="flex items-center justify-between">
            <h2 class="text-lg font-semibold">Gi·ªè h√†ng</h2>
            <button id="clearCart" class="text-sm underline">X√≥a gi·ªè</button>
          </div>
          <div id="cartList" class="mt-3 divide-y"></div>
          <div class="mt-3 flex items-center justify-between font-semibold">
            <div>T·ªïng</div><div id="cartTotal">0 ƒë</div>
          </div>
        </div>

        <div class="rounded-2xl bg-white border shadow-soft p-4">
          <h3 class="text-lg font-semibold">Th√¥ng tin giao h√†ng</h3>
          <form id="checkoutForm" class="mt-3 space-y-3">
            <div>
              <label class="text-sm text-neutral-600">H·ªç t√™n</label>
              <input required name="name" class="w-full mt-1 rounded-xl border px-3 py-2" placeholder="Nguy·ªÖn VƒÉn A">
            </div>
            <div>
              <label class="text-sm text-neutral-600">S·ªë ƒëi·ªán tho·∫°i</label>
              <input required name="phone" class="w-full mt-1 rounded-xl border px-3 py-2" placeholder="098xxxxxxx" pattern="[0-9+ ]{8,}">
            </div>
            <div>
              <label class="text-sm text-neutral-600">ƒê·ªãa ch·ªâ</label>
              <input required name="address" class="w-full mt-1 rounded-xl border px-3 py-2" placeholder="S·ªë nh√†, ƒë∆∞·ªùng, ph∆∞·ªùng/x√£, qu·∫≠n/huy·ªán">
            </div>
            <div>
              <label class="text-sm text-neutral-600">Ghi ch√∫</label>
              <textarea name="notes" class="w-full mt-1 rounded-xl border px-3 py-2" rows="2" placeholder="V√≠ d·ª•: √çt ƒë√°, √≠t ng·ªçt‚Ä¶"></textarea>
            </div>
            <div>
              <label class="text-sm text-neutral-600">Thanh to√°n</label>
              <select name="pay" class="w-full mt-1 rounded-xl border px-3 py-2">
                <option value="COD">Ti·ªÅn m·∫∑t khi nh·∫≠n</option>
                <option value="BANK">Chuy·ªÉn kho·∫£n</option>
              </select>
            </div>
            <button id="placeOrder" class="w-full bg-black text-white py-3 rounded-xl font-medium">ƒê·∫∑t h√†ng</button>
            <div id="orderMsg" class="text-sm mt-2"></div>
          </form>
        </div>

        <p class="text-xs text-neutral-500">B·∫±ng vi·ªác ƒë·∫∑t h√†ng, b·∫°n ƒë·ªìng √Ω v·ªõi ƒëi·ªÅu kho·∫£n d·ªãch v·ª• c·ªßa CAFE ‚Äî CACAO.</p>
      </aside>
    </div>
  </main>

  <footer class="border-t bg-white">
    <div class="max-w-screen-2xl mx-auto px-4 py-6 text-sm text-neutral-600 flex flex-col sm:flex-row gap-2 sm:items-center sm:justify-between">
      <div>¬© <span id="year"></span> CAFE ‚Äî CACAO</div>
      <div class="flex gap-3">
        <a class="underline" href="index.html">Trang ch·ªß</a>
        <a class="underline" href="admin.html">Admin</a>
      </div>
    </div>
  </footer>

<script>
/* ================= CONFIG ================= */
const SUPABASE_URL  = 'https://peenohpyubshzxgzzkhx.supabase.co';
const SUPABASE_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBlZW5vaHB5dWJzaHp4Z3p6a2h4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg5OTczOTYsImV4cCI6MjA3NDU3MzM5Nn0.5PJYRCGyhM-E16yJrU5W_kBeDQgaJiine4j_cS9gKoU';
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

/* ======= i18n (minimal) ======= */
let LANG = localStorage.getItem('lang') || 'vi';
document.getElementById('btnVI').onclick = ()=>{LANG='vi';localStorage.setItem('lang','vi');render();};
document.getElementById('btnEN').onclick = ()=>{LANG='en';localStorage.setItem('lang','en');render();};
document.getElementById('year').textContent = new Date().getFullYear();

/* ======= State ======= */
let PRODUCTS = [];          // full from DB
let VIEW = {cat:'All', subcat:'All', q:''};  // filters
let CART = JSON.parse(localStorage.getItem('cart_v1') || '[]'); // [{id, name, price_vnd, qty, image_url}]

/* ======= Utils ======= */
const moneyK = (v)=> {
  const n = Number(v||0);
  return n ? (Math.round(n/1000)+'k') : '0';
};
const qs = (s, r=document)=> r.querySelector(s);
const qsa = (s, r=document)=> [...r.querySelectorAll(s)];
const setCart = (arr)=> { CART = arr; localStorage.setItem('cart_v1', JSON.stringify(CART)); renderCart(); };
const addToCart = (p)=> {
  const i = CART.findIndex(x=>x.id===p.id);
  if (i>=0){ CART[i].qty += 1; } else {
    CART.push({id:p.id, name:pickTitle(p), price_vnd:p.price_vnd, image_url:p.image_url, qty:1});
  }
  setCart(CART);
};
const pickTitle = (row)=> LANG==='vi' ? (row.name_vi || row.name_en || '') : (row.name_en || row.name_vi || '');

/* ======= Fetch products ======= */
async function loadProducts(){
  const url = new URL(location.href);
  const urlCat = url.searchParams.get('category');
  const urlSub = url.searchParams.get('subcategory');
  if (urlCat) VIEW.cat = urlCat;
  if (urlSub) VIEW.subcat = urlSub;

  // Select * so old/new schemas both work
  let { data, error } = await sb
    .from('products')
    .select('*');

  if (error){ document.querySelector('#error').classList.remove('hidden'); return; }

  // normalize
  const norm = (p)=>({
    id: p.id,
    slug: p.slug,
    category: p.category || p.section || '',
    subcategory: p.subcategory || p.subgroup || '',
    name_vi: p.name_vi || p.name || '',
    name_en: p.name_en || '',
    description_vi: p.description_vi || p.description || '',
    price_vnd: (p.price_vnd != null) ? p.price_vnd : (p.price != null ? p.price : 0),
    size: p.size || '',
    is_available: ('is_available' in p) ? p.is_available : (('is_active' in p) ? p.is_active : true),
    image_url: p.image_url || '',
    tags: p.tags || '',
    sort_order: ('sort_order' in p) ? p.sort_order : 100
  });

  PRODUCTS = (data||[]).map(norm).filter(p => p.is_available);
  // order for nice UX
  PRODUCTS.sort((a,b)=>{
    if (a.category!==b.category) return (a.category||'').localeCompare(b.category||'');
    if (a.subcategory!==b.subcategory) return (a.subcategory||'').localeCompare(b.subcategory||'');
    return (a.sort_order??100)-(b.sort_order??100);
  });

  buildSubcats();
  render();
}

/* ======= Build subcategory pills ======= */
function buildSubcats(){
  const wrap = qs('#subcats'); wrap.innerHTML='';
  const cats = new Set(PRODUCTS.map(p=>p.category));
  // if URL cat unknown, default to first available
  if (VIEW.cat!=='All' && !cats.has(VIEW.cat)) VIEW.cat='All';

  const subSet = new Set(PRODUCTS
    .filter(p=>VIEW.cat==='All' ? true : p.category===VIEW.cat)
    .map(p=>p.subcategory)
  );
  const subcats = ['All', ...[...subSet].filter(Boolean)];
  subcats.forEach(sc=>{
    const b = document.createElement('button');
    b.textContent = sc==='All' ? (LANG==='vi'?'T·∫•t c·∫£':'All') : sc;
    b.className = 'pill px-3 py-1.5 rounded-lg border bg-white text-sm';
    b.dataset.subcat = sc;
    if (VIEW.subcat===sc) b.classList.add('bg-black','text-white','border-black');
    b.onclick = ()=>{VIEW.subcat=sc; render();};
    wrap.appendChild(b);
  });

  // mark main cat buttons
  qsa('.cat').forEach(btn=>{
    btn.classList.remove('bg-black','text-white','border-black','font-medium');
    if (btn.dataset.cat===VIEW.cat) btn.classList.add('bg-black','text-white','border-black','font-medium');
    btn.onclick = ()=>{VIEW.cat = btn.dataset.cat; VIEW.subcat='All'; buildSubcats(); render(); };
  });
}

/* ======= Render grid (filters + search) ======= */
function render(){
  const grid = qs('#grid'); grid.innerHTML='';
  qs('#empty').classList.add('hidden'); qs('#error').classList.add('hidden');

  const query = VIEW.q.trim().toLowerCase();
  const filtered = PRODUCTS.filter(p=>{
    if (VIEW.cat!=='All' && p.category!==VIEW.cat) return false;
    if (VIEW.subcat!=='All' && p.subcategory!==VIEW.subcat) return false;
    if (!query) return true;
    const hay = [
      p.name_vi||'', p.name_en||'', p.category||'', p.subcategory||'',
      p.tags||'', p.description_vi||''
    ].join(' ').toLowerCase();
    return hay.includes(query);
  });

  if (!filtered.length){ qs('#empty').classList.remove('hidden'); return; }

  filtered.forEach(p=>{
    const card = document.createElement('div');
    card.className = 'card rounded-2xl bg-white border shadow-soft overflow-hidden';
    card.innerHTML = `
      ${p.image_url ? `<img src="${p.image_url}" class="w-full h-40 object-cover" alt="">`
                    : `<div class="w-full h-40 bg-neutral-100 grid place-items-center text-neutral-400">${(p.category||'').slice(0,2)}</div>`}
      <div class="p-4">
        <div class="font-semibold line-clamp-2">${pickTitle(p)}</div>
        <div class="text-xs text-neutral-500 mt-0.5">${p.category||''}${p.subcategory?(' ‚Ä¢ '+p.subcategory):''}${p.size?(' ‚Ä¢ '+p.size):''}</div>
        <div class="mt-2 font-semibold">${moneyK(p.price_vnd)}</div>
        <div class="mt-3 flex items-center gap-2">
          <button class="add bg-black text-white px-3 py-2 rounded-lg" data-id="${p.id}">Th√™m</button>
          <button class="bg-white border px-3 py-2 rounded-lg" data-jump="${p.category}" data-jump-sub="${p.subcategory||''}">T∆∞∆°ng t·ª±</button>
        </div>
      </div>`;
    grid.appendChild(card);
  });

  // wire add buttons
  qsa('button.add', grid).forEach(btn=>{
    btn.onclick = ()=>{
      const p = PRODUCTS.find(x=>x.id===btn.dataset.id);
      if (p) addToCart(p);
    };
  });

  // quick nav ‚Äúsimilar‚Äù
  qsa('button[data-jump]', grid).forEach(btn=>{
    btn.onclick = ()=>{
      VIEW.cat = btn.dataset.jump || 'All';
      VIEW.subcat = btn.dataset.jumpSub || 'All';
      buildSubcats(); render();
    };
  });
}

/* ======= Search ======= */
qs('#search').addEventListener('input', e=>{ VIEW.q = e.target.value; render(); });

/* ======= Cart render ======= */
function renderCart(){
  const list = qs('#cartList'); list.innerHTML='';
  if (!CART.length){ list.innerHTML = `<div class="text-sm text-neutral-500">Ch∆∞a c√≥ m√≥n n√†o.</div>`; }
  let total = 0;
  CART.forEach((it, idx)=>{
    const lineTotal = (it.price_vnd||0) * (it.qty||0);
    total += lineTotal;
    const row = document.createElement('div');
    row.className = 'py-2 flex items-center gap-3';
    row.innerHTML = `
      <div class="w-12 h-12 rounded-lg bg-neutral-100 overflow-hidden flex-shrink-0">
        ${it.image_url? `<img class="w-full h-full object-cover" src="${it.image_url}">` : ''}
      </div>
      <div class="flex-1">
        <div class="text-sm font-medium">${it.name}</div>
        <div class="text-xs text-neutral-500">${moneyK(it.price_vnd)} √ó ${it.qty}</div>
      </div>
      <div class="text-sm font-semibold">${moneyK(lineTotal)}</div>
      <div class="flex items-center gap-1 ml-2">
        <button class="dec border rounded px-2" data-idx="${idx}">-</button>
        <button class="inc border rounded px-2" data-idx="${idx}">+</button>
        <button class="del text-red-600 text-xs underline ml-1" data-idx="${idx}">x</button>
      </div>
    `;
    list.appendChild(row);
  });
  qs('#cartTotal').textContent = (total||0).toLocaleString('vi-VN') + ' ƒë';

  // qty controls
  qsa('.dec', list).forEach(b=>{ b.onclick=()=>{ const i=+b.dataset.idx; CART[i].qty=Math.max(0,CART[i].qty-1); if(CART[i].qty===0) CART.splice(i,1); setCart(CART);} });
  qsa('.inc', list).forEach(b=>{ b.onclick=()=>{ const i=+b.dataset.idx; CART[i].qty++; setCart(CART);} });
  qsa('.del', list).forEach(b=>{ b.onclick=()=>{ const i=+b.dataset.idx; CART.splice(i,1); setCart(CART);} });
}
qs('#clearCart').onclick = ()=> setCart([]);

/* ======= Checkout ======= */
/** Expected tables (create once in SQL):
create table if not exists public.orders (
  id uuid primary key default gen_random_uuid(),
  code text unique not null,
  customer_name text not null,
  phone text not null,
  address text not null,
  notes text,
  payment_method text default 'COD',
  status text default 'pending',
  total_vnd integer not null,
  created_at timestamp with time zone default now()
);
create table if not exists public.order_items (
  id uuid primary key default gen_random_uuid(),
  order_id uuid references public.orders(id) on delete cascade,
  product_id text,
  name_snapshot text,
  price_vnd integer not null,
  qty integer not null,
  line_total_vnd integer not null
);
*/
function randCode(){
  const t = new Date();
  const y = String(t.getFullYear()).slice(2);
  const m = String(t.getMonth()+1).padStart(2,'0');
  const d = String(t.getDate()).padStart(2,'0');
  const n = Math.random().toString(36).slice(2,6).toUpperCase();
  return `CC${y}${m}${d}-${n}`;
}

qs('#checkoutForm').addEventListener('submit', async (e)=>{
  e.preventDefault();
  const msg = qs('#orderMsg'); msg.textContent = ''; msg.className='text-sm mt-2';
  if (!CART.length){ msg.textContent = 'Gi·ªè h√†ng tr·ªëng.'; msg.classList.add('text-red-600'); return; }

  const fd = new FormData(e.target);
  const order = {
    code: randCode(),
    customer_name: fd.get('name')?.trim(),
    phone: fd.get('phone')?.trim(),
    address: fd.get('address')?.trim(),
    notes: fd.get('notes')?.trim() || null,
    payment_method: fd.get('pay') || 'COD',
    total_vnd: CART.reduce((s,it)=> s + (it.price_vnd*it.qty), 0),
    status: 'pending'
  };

  // Basic guard
  if (!order.customer_name || !order.phone || !order.address){
    msg.textContent = 'Vui l√≤ng nh·∫≠p ƒë·ªß h·ªç t√™n, s·ªë ƒëi·ªán tho·∫°i v√† ƒë·ªãa ch·ªâ.'; msg.classList.add('text-red-600'); return;
  }

  qs('#placeOrder').disabled = true; qs('#placeOrder').textContent = 'ƒêang t·∫°o ƒë∆°n‚Ä¶';

  // 1) Insert order
  const { data:ordRes, error:ordErr } = await sb.from('orders').insert(order).select('id, code').single();
  if (ordErr){ 
    msg.textContent = 'Kh√¥ng t·∫°o ƒë∆∞·ª£c ƒë∆°n h√†ng. Vui l√≤ng th·ª≠ l·∫°i.'; msg.classList.add('text-red-600');
    qs('#placeOrder').disabled = false; qs('#placeOrder').textContent = 'ƒê·∫∑t h√†ng';
    return;
  }

  // 2) Insert order items (snapshot names/prices)
  const items = CART.map(it=>({
    order_id: ordRes.id,
    product_id: it.id,
    name_snapshot: it.name,
    price_vnd: it.price_vnd,
    qty: it.qty,
    line_total_vnd: it.price_vnd * it.qty
  }));
  const { error:itemErr } = await sb.from('order_items').insert(items);
  if (itemErr){
    msg.textContent = 'ƒê∆°n ƒë√£ t·∫°o nh∆∞ng th√™m m√≥n th·∫•t b·∫°i. Li√™n h·ªá c·ª≠a h√†ng.'; msg.classList.add('text-red-600');
    qs('#placeOrder').disabled = false; qs('#placeOrder').textContent = 'ƒê·∫∑t h√†ng';
    return;
  }

  // Success
  msg.innerHTML = `üéâ ƒê·∫∑t h√†ng th√†nh c√¥ng! M√£ ƒë∆°n: <b>${ordRes.code}</b>`;
  msg.classList.remove('text-red-600'); msg.classList.add('text-green-700');
  setCart([]); e.target.reset();
  qs('#placeOrder').disabled = false; qs('#placeOrder').textContent = 'ƒê·∫∑t h√†ng';
});

/* ======= Boot ======= */
loadProducts();
renderCart();

// handle prefilled filters via URL
const url = new URL(location.href);
const urlCat = url.searchParams.get('category');
const urlSub = url.searchParams.get('subcategory');
if (urlCat){ VIEW.cat = urlCat; }
if (urlSub){ VIEW.subcat = urlSub; }
</script>
</body>
</html>
