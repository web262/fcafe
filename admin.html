<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin — Orders | CAFE — CACAO</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root{ --muted:#64748b; }
    body{
      color:#111827;
      background:
        radial-gradient(1200px 500px at -10% -20%, #FFE8A3 0, #FFE8A3 25%, transparent 60%),
        radial-gradient(900px 450px at 110% 0%, #FF8FAB40 0, transparent 60%),
        linear-gradient(180deg, #FFF 0, #FFF9F0 100%);
    }
    .glass{backdrop-filter:saturate(130%) blur(10px); background:rgba(255,255,255,.6)}
    .chip{border-radius:9999px;padding:.5rem .9rem;border:1px solid rgba(15,23,42,.12);background:#fff;transition:.15s}
    .chip.active{background:#111;color:#fff;border-color:#111}
    .card{transition:transform .18s ease, box-shadow .18s ease}
    .card:hover{transform:translateY(-2px); box-shadow:0 16px 34px rgba(0,0,0,.08)}
    .status{border:1px solid rgba(15,23,42,.12); padding:.15rem .5rem; border-radius:9999px; font-size:.75rem}
    .st-pending{background:#fff;border-color:#e5e7eb}
    .st-paid{background:#E6FFE8;border-color:#34D399}
    .st-delivered,.st-completed{background:#E8F1FF;border-color:#60A5FA}
    .st-cancelled,.st-canceled{background:#FFE8EC;border-color:#FF8FAB}
    @media print{ .no-print{display:none!important} body{background:#fff} }
  </style>
</head>
<body>

  <!-- Header -->
  <header class="sticky top-0 z-40 border-b"
          style="background:linear-gradient(90deg,#fff9 0,#fff9),linear-gradient(90deg,#FFE8A3 0,#FFB86B 22%,#FF8FAB 48%,#60A5FA 76%,#A78BFA 100%)">
    <div class="max-w-7xl mx-auto px-4 h-14 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="h-8 w-8 rounded-xl bg-black text-white grid place-items-center font-bold">C</div>
        <div class="leading-tight">
          <div class="font-semibold tracking-wide">CAFE — CACAO</div>
          <div class="text-xs text-[var(--muted)]">Admin • Orders</div>
        </div>
      </div>
      <div class="no-print flex items-center gap-2">
        <a href="./index.html" class="px-3 py-2 rounded-lg border bg-white hover:bg-neutral-50">← Trang chủ</a>
        <button id="exportOrders" class="px-3 py-2 rounded-lg bg-black text-white">Export CSV</button>
      </div>
    </div>
  </header>

  <!-- Filters -->
  <section class="no-print sticky top-14 z-30 border-b glass">
    <div class="max-w-7xl mx-auto px-4 py-3 grid gap-3 md:grid-cols-[1fr_auto_auto]">
      <input id="q" placeholder="Tìm: tên / số điện thoại / địa chỉ / mã đơn…" class="border rounded-xl px-3 py-2 bg-white w-full">
      <div class="flex gap-2">
        <input id="dateFrom" type="date" class="border rounded-xl px-3 py-2 bg-white">
        <input id="dateTo"   type="date" class="border rounded-xl px-3 py-2 bg-white">
      </div>
      <div class="flex flex-wrap gap-2">
        <button data-st="all"       class="chip active">Tất cả</button>
        <button data-st="pending"   class="chip">Pending</button>
        <button data-st="paid"      class="chip">Paid</button>
        <button data-st="delivered" class="chip">Delivered</button>
        <button data-st="cancelled" class="chip">Cancelled</button>
      </div>
    </div>
  </section>

  <!-- List -->
  <main class="max-w-7xl mx-auto px-4 py-6">
    <div id="list" class="grid gap-4">
      <div class="grid sm:grid-cols-2 gap-4" id="skeleton">
        <div class="rounded-2xl border p-4 bg-white animate-pulse">
          <div class="h-4 bg-neutral-100 rounded w-3/5"></div>
          <div class="h-4 bg-neutral-100 rounded w-2/5 mt-2"></div>
          <div class="h-24 bg-neutral-100 rounded mt-3"></div>
        </div>
        <div class="rounded-2xl border p-4 bg-white animate-pulse">
          <div class="h-4 bg-neutral-100 rounded w-3/5"></div>
          <div class="h-4 bg-neutral-100 rounded w-2/5 mt-2"></div>
          <div class="h-24 bg-neutral-100 rounded mt-3"></div>
        </div>
      </div>
    </div>
    <p id="empty" class="hidden text-neutral-500 mt-10 text-center">Chưa có đơn hàng.</p>
  </main>

  <footer class="border-t"
          style="background:linear-gradient(90deg,#FFE8A3 0,#FFB86B 22%,#FF8FAB 48%,#60A5FA 76%,#A78BFA 100%)">
    <div class="max-w-7xl mx-auto px-4 py-5 text-sm text-neutral-800/80">
      © <span id="year"></span> CAFE — CACAO · Admin
    </div>
  </footer>

<script>
/* ========= CONFIG ========= */
const SUPABASE_URL  = 'https://peenohpyubshzxgzzkhx.supabase.co';
const SUPABASE_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBlZW5vaHB5dWJzaHp4Z3p6a2h4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg5OTczOTYsImV4cCI6MjA3NDU3MzM5Nn0.5PJYRCGyhM-E16yJrU5W_kBeDQgaJiine4j_cS9gKoU';
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON);
document.getElementById('year').textContent = new Date().getFullYear();

/* ========= Helpers ========= */
const money = v => (Number(v)||0).toLocaleString('vi-VN') + ' đ';
let statusFilter = 'all';

// Accept both our UI values and common DB variants
const STATUS_FALLBACK = { delivered: 'completed', cancelled: 'canceled' };
const STATUS_CLASSES = s => {
  const k = (s||'pending').toLowerCase();
  return k==='paid' ? 'st-paid'
    : (k==='delivered'||k==='completed') ? 'st-delivered'
    : (k==='cancelled'||k==='canceled') ? 'st-cancelled'
    : 'st-pending';
};
const getAddr = (o) => o.address ?? o.address_snapshot ?? '';

/* ========= Auth guard ========= */
const ADMIN_EMAILS = ['shivammishra.id@gmail.com']; // adjust list as needed

function renderLoginUI() {
  document.body.innerHTML = `
  <main class="min-h-screen grid place-items-center p-6 bg-gradient-to-b from-white to-amber-50">
    <div class="w-full max-w-md bg-white border rounded-2xl p-6 shadow-sm">
      <h1 class="text-xl font-semibold">Admin Login</h1>
      <form id="loginForm" class="mt-4 space-y-3">
        <input type="email" name="email" required placeholder="Email" class="w-full border rounded-xl px-3 py-2">
        <input type="password" name="password" required placeholder="Password" class="w-full border rounded-xl px-3 py-2">
        <button class="w-full bg-black text-white rounded-xl py-2">Sign in</button>
      </form>
    </div>
  </main>`;
  const f = document.getElementById('loginForm');
  f.onsubmit = async (e)=>{
    e.preventDefault();
    const { error } = await sb.auth.signInWithPassword({
      email: f.email.value.trim(),
      password: f.password.value
    });
    if (error) { alert('Đăng nhập thất bại'); console.error(error); return; }
    location.reload();
  };
}

async function requireAdmin() {
  const { data: { user } } = await sb.auth.getUser();
  if (!user) { renderLoginUI(); throw new Error('not signed in'); }
  const ok = ADMIN_EMAILS.includes((user.email||'').toLowerCase());
  if (!ok) { document.body.innerHTML = '<main class="p-8">No access.</main>'; throw new Error('not admin'); }
  return user;
}

/* ===== Safe DOM helpers ===== */
const $ = sel => document.querySelector(sel);

/* ===== fetch order_items with schema fallback ===== */
async function fetchOrderItems(orderIds){
  // Newer schema
  let res = await sb.from('order_items')
    .select('order_id, name_snapshot, price_vnd, qty, line_total_vnd')
    .in('order_id', orderIds);

  // Fallback to older schema with unit_price/name
  if (res.error && res.error.code === '42703') {
    res = await sb.from('order_items')
      .select('order_id, name, unit_price, qty')
      .in('order_id', orderIds);
    if (!res.error) {
      res.data = (res.data || []).map(it => ({
        order_id: it.order_id,
        name_snapshot: it.name,
        price_vnd: it.unit_price,
        qty: it.qty,
        line_total_vnd: (Number(it.unit_price)||0) * (Number(it.qty)||0)
      }));
    }
  }
  return res;
}

/* ========= Load ========= */
async function load(){
  const sk = $('#skeleton'); if (sk) sk.classList.remove('hidden');

  const q    = $('#q').value.trim().toLowerCase();
  const from = $('#dateFrom').value;
  const to   = $('#dateTo').value;

  let oQuery = sb.from('orders').select('*').order('created_at', { ascending:false });
  if (from) oQuery = oQuery.gte('created_at', from);
  if (to)   oQuery = oQuery.lte('created_at', to + ' 23:59:59');

  if (statusFilter !== 'all') {
    const alt = STATUS_FALLBACK[statusFilter];
    oQuery = alt ? oQuery.in('status', [statusFilter, alt]) : oQuery.eq('status', statusFilter);
  }

  const { data: orders, error: oErr } = await oQuery;
  if (oErr){ console.error(oErr); alert('Tải đơn hàng thất bại'); return; }
  if (!orders?.length){ render([]); return; }

  const orderIds = orders.map(o=>o.id);
  const { data: items, error: iErr } = await fetchOrderItems(orderIds);
  if (iErr){ console.error(iErr); }

  const itemsByOrder = {};
  (items||[]).forEach(it => (itemsByOrder[it.order_id] ||= []).push(it));

  const merged = orders.map(o => ({...o, order_items: itemsByOrder[o.id] || []}));

  const filtered = q
    ? merged.filter(o=>{
        const hay = [
          o.customer_name||'', o.phone||'', getAddr(o)||'', o.code||'', o.id||''
        ].join(' ').toLowerCase();
        return hay.includes(q);
      })
    : merged;

  render(filtered);
}

/* ========= Status setter with fallback ========= */
function isStatusConstraint(err){
  return err && (err.code === '23514' || /status_check/i.test(err.message||''));
}
async function setOrderStatus(orderId, want){
  const trySet = (val) => sb.from('orders').update({ status: val }).eq('id', orderId);
  let { error } = await trySet(want);
  if (!error) return { ok:true };
  if (isStatusConstraint(error)) {
    const alt = STATUS_FALLBACK[want];
    if (alt) {
      const retry = await trySet(alt);
      if (!retry.error) return { ok:true };
      error = retry.error;
    }
  }
  return { ok:false, error };
}

/* ========= Render ========= */
function render(orders){
  const list = $('#list');
  const empty = $('#empty');
  const sk = $('#skeleton'); if (sk) sk.classList.add('hidden');

  list.innerHTML = '';
  empty.classList.toggle('hidden', orders.length>0);

  orders.forEach(o=>{
    const itemsHtml = (o.order_items||[]).map(it=>`
      <div class="flex justify-between text-sm">
        <div class="truncate">${it.name_snapshot}</div>
        <div class="shrink-0">${it.qty} × ${money(it.price_vnd)}</div>
      </div>
    `).join('');

    const subtotalCalc = (o.order_items||[]).reduce((s,it)=> s + (Number(it.line_total_vnd)||0), 0);
    const totalDisplay = (o.total_vnd!=null ? o.total_vnd : subtotalCalc);
    const st = (o.status||'pending').toLowerCase();

    const card = document.createElement('div');
    card.className = 'card bg-white border rounded-2xl p-4';
    card.innerHTML = `
      <div class="flex flex-wrap items-start justify-between gap-3">
        <div>
          <div class="text-sm text-neutral-500">#${o.code || (o.id||'').slice(0,8)} • ${new Date(o.created_at).toLocaleString('vi-VN')}</div>
          <div class="font-semibold mt-1">${o.customer_name || '—'} • ${o.phone || ''}</div>
          <div class="text-sm text-neutral-700">${getAddr(o)}</div>
          ${(o.notes || o.note) ? `<div class="text-sm mt-1 italic text-neutral-600">Ghi chú: ${o.notes || o.note}</div>` : ''}
          <div class="text-xs mt-1 text-neutral-500">Thanh toán: ${o.payment_method || '—'}</div>
        </div>
        <div class="text-right min-w-[180px]">
          <div class="text-neutral-600 text-sm">Tạm tính: ${money(subtotalCalc)}</div>
          <div class="font-semibold text-lg mt-1">Tổng: ${money(totalDisplay)}</div>
          <div class="status ${STATUS_CLASSES(st)} mt-1 inline-block">${st}</div>
          <div class="no-print mt-2 flex flex-wrap gap-2 justify-end">
            <button class="px-3 py-1 rounded-lg border bg-white hover:bg-neutral-50" data-act="copy">Copy địa chỉ</button>
            <a class="px-3 py-1 rounded-lg border bg-white hover:bg-neutral-50" target="_blank"
               href="https://www.google.com/maps/search/${encodeURIComponent(getAddr(o))}">Bản đồ</a>
            <button class="px-3 py-1 rounded-lg bg-black text-white" data-act="print">In hóa đơn</button>
            <button class="px-3 py-1 rounded-lg border bg-white hover:bg-neutral-50" data-act="set:paid">Mark Paid</button>
            <button class="px-3 py-1 rounded-lg border bg-white hover:bg-neutral-50" data-act="set:delivered">Delivered</button>
            <button class="px-3 py-1 rounded-lg border bg-white hover:bg-neutral-50 text-red-600" data-act="set:cancelled">Cancel</button>
          </div>
        </div>
      </div>

      <div class="mt-3 border-t pt-3">
        <div class="font-medium mb-1">Món</div>
        <div class="grid gap-1">${itemsHtml}</div>
      </div>
    `;

    card.querySelectorAll('[data-act]').forEach(btn=>{
      btn.onclick = async ()=>{
        const act = btn.dataset.act;

        if (act === 'copy'){
          await navigator.clipboard.writeText(getAddr(o));
          btn.textContent = 'Đã copy!'; setTimeout(()=>btn.textContent='Copy địa chỉ',1200);
          return;
        }

        if (act === 'print'){ printReceipt(o); return; }

        if (act.startsWith('set:')){
          const want = act.split(':')[1]; // paid / delivered / cancelled
          btn.disabled = true;
          const res = await setOrderStatus(o.id, want);
          btn.disabled = false;
          if (!res.ok){ alert('Cập nhật trạng thái thất bại'); console.error(res.error); }
          else load();
        }
      };
    });

    list.appendChild(card);
  });
}

/* ========= Print ========= */
function printReceipt(o){
  const items = o.order_items || [];
  const rows = items.map(it=>`
    <tr>
      <td style="padding:6px 0">${it.name_snapshot}</td>
      <td style="text-align:center">${it.qty}</td>
      <td style="text-align:right">${money(it.price_vnd)}</td>
      <td style="text-align:right">${money((it.line_total_vnd)|| (it.price_vnd*it.qty))}</td>
    </tr>
  `).join('');
  const subtotal = items.reduce((s,it)=> s + (it.line_total_vnd||it.price_vnd*it.qty||0), 0);
  const totalDisplay = (o.total_vnd!=null ? o.total_vnd : subtotal);

  const wnd = window.open('', '_blank', 'width=420,height=620');
  wnd.document.write(`
    <html><head><title>Receipt ${o.code || (o.id||'').slice(0,8)}</title>
    <style>
      body{font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;padding:20px}
      h1{font-size:18px;margin:0}
      .muted{color:#6b7280;font-size:12px}
      table{width:100%;border-collapse:collapse;margin-top:10px}
      td,th{font-size:14px;border-top:1px solid #eee;padding:6px 0}
      .totals td{font-weight:600}
      .badge{display:inline-block;border:1px solid #e5e7eb;border-radius:9999px;padding:2px 8px;font-size:12px}
      @media print {.no-print{display:none}}
    </style></head><body>
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h1>CAFE — CACAO</h1>
        <span class="badge">${o.status}</span>
      </div>
      <div class="muted">Order #${o.code || o.id}</div>
      <div class="muted">${new Date(o.created_at).toLocaleString('vi-VN')}</div>

      <div style="margin-top:12px">
        <div><strong>${o.customer_name || ''}</strong> • ${o.phone || ''}</div>
        <div class="muted">${getAddr(o)}</div>
        ${(o.notes || o.note) ? `<div class="muted">Note: ${o.notes || o.note}</div>` : ''}
        <div class="muted">Thanh toán: ${o.payment_method || '—'}</div>
      </div>

      <table>
        <thead>
          <tr><th style="text-align:left">Món</th><th>SL</th><th style="text-align:right">Giá</th><th style="text-align:right">Thành tiền</th></tr>
        </thead>
        <tbody>${rows}</tbody>
        <tfoot>
          <tr class="totals"><td colspan="3" style="text-align:right">Tạm tính</td><td style="text-align:right">${money(subtotal)}</td></tr>
          <tr class="totals"><td colspan="3" style="text-align:right">Tổng</td><td style="text-align:right">${money(totalDisplay)}</td></tr>
        </tfoot>
      </table>

      <p class="muted" style="margin-top:14px">Cảm ơn bạn!</p>
      <button class="no-print" onclick="window.print()">In</button>
    </body></html>
  `);
  wnd.document.close();
  wnd.focus();
  wnd.onload = () => wnd.print();
}

/* ========= Export CSV ========= */
document.getElementById('exportOrders').onclick = async ()=>{
  const { data: orders, error: oErr } = await sb.from('orders').select('*').order('created_at', { ascending:false });
  if (oErr){ console.error(oErr); alert('Export thất bại (orders)'); return; }
  if (!orders?.length){ alert('Không có đơn'); return; }

  const orderIds = orders.map(o=>o.id);
  const { data: items, error: iErr } = await fetchOrderItems(orderIds);
  if (iErr){ console.error(iErr); alert('Export thất bại (items)'); return; }

  const itemsByOrder = {};
  (items||[]).forEach(it => (itemsByOrder[it.order_id] ||= []).push(it));

  const hasCode = orders.some(o => 'code' in o);
  const header = hasCode
    ? ['order_id','code','created_at','status','customer_name','phone','address','notes','payment_method','total_vnd','items']
    : ['order_id','created_at','status','customer_name','phone','address','notes','payment_method','total_vnd','items'];

  const rows = [header];

  orders.forEach(o=>{
    const parts = (itemsByOrder[o.id]||[]).map(it=>`${it.qty}x ${it.name_snapshot} @ ${it.price_vnd}`).join(' | ');
    const base = [
      o.id,
      o.created_at, o.status, o.customer_name||'', o.phone||'',
      getAddr(o), (o.notes||o.note||''), o.payment_method||'',
      (o.total_vnd!=null ? o.total_vnd : (itemsByOrder[o.id]||[]).reduce((s,it)=>s+(it.line_total_vnd||0),0)),
      parts
    ];
    if (hasCode) base.splice(1,0,(o.code||'')); // insert code after id
    rows.push(base);
  });

  const csv = rows.map(r => r.map(v => `"${String(v).replace(/"/g,'""')}"`).join(',')).join('\n');
  const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
  const url  = URL.createObjectURL(blob);
  const a = Object.assign(document.createElement('a'), {href:url, download:'orders_export.csv'});
  document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
};

/* ========= Filters ========= */
$('#q').addEventListener('input', load);
$('#dateFrom').addEventListener('change', load);
$('#dateTo').addEventListener('change', load);
document.querySelectorAll('[data-st]').forEach(b=>{
  b.onclick = ()=>{
    document.querySelectorAll('[data-st]').forEach(x=>x.classList.remove('active'));
    b.classList.add('active');
    statusFilter = b.dataset.st;
    load();
  };
});

/* ========= Boot ========= */
(async function boot(){
  try {
    await requireAdmin();
    await load();
  } catch (err) {
    console.warn(err);
  }
})();
</script>
</body>
</html>
