<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin ‚Äî Orders</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body class="bg-neutral-50 text-neutral-900">
  <div class="max-w-7xl mx-auto px-4 py-6">
    <div class="flex items-center justify-between">
      <h1 class="text-2xl font-bold">üì¶ Admin ‚Äî Orders</h1>
      <div class="flex gap-2">
        <a href="./" class="px-3 py-2 rounded-lg border bg-white">‚Üê Storefront</a>
        <button id="exportCustomers" class="px-3 py-2 rounded-lg bg-black text-white">Export customers (CSV)</button>
      </div>
    </div>

    <div class="mt-4 grid md:grid-cols-3 gap-3">
      <input id="q" placeholder="Search name/phone‚Ä¶" class="border rounded-xl px-3 py-2 bg-white">
      <input id="dateFrom" type="date" class="border rounded-xl px-3 py-2 bg-white">
      <input id="dateTo" type="date" class="border rounded-xl px-3 py-2 bg-white">
    </div>

    <div id="list" class="mt-6 grid gap-4"></div>
    <p id="empty" class="hidden text-neutral-500 mt-10 text-center">No orders yet.</p>
  </div>

<script>
/* ==== CONFIG ==== */
const SUPABASE_URL = 'https://peenohpyubshzxgzzkhx.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBlZW5vaHB5dWJzaHp4Z3p6a2h4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg5OTczOTYsImV4cCI6MjA3NDU3MzM5Nn0.5PJYRCGyhM-E16yJrU5W_kBeDQgaJiine4j_cS9gKoU';
/* ================ */

const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
const money = v => (v||0).toLocaleString('vi-VN') + ' ƒë';

async function load() {
  const q = document.getElementById('q').value.trim().toLowerCase();
  const from = document.getElementById('dateFrom').value;
  const to   = document.getElementById('dateTo').value;

  // 1) Orders (no embedding)
  let oQuery = sb.from('orders')
    .select('id, created_at, status, subtotal, delivery_fee, total, note, address_snapshot, customer_id')
    .order('created_at', { ascending:false });

  if (from) oQuery = oQuery.gte('created_at', from);
  if (to)   oQuery = oQuery.lte('created_at', to + ' 23:59:59');

  const { data: orders, error: oErr } = await oQuery;
  if (oErr) { console.error(oErr); alert('Failed to load orders'); return; }
  if (!orders?.length) { render([]); return; }

  // 2) Fetch customers for these orders
  const customerIds = [...new Set(orders.map(o => o.customer_id).filter(Boolean))];
  let customersById = {};
  if (customerIds.length) {
    const { data: cust, error: cErr } = await sb.from('customers')
      .select('id, name, phone')
      .in('id', customerIds);
    if (cErr) { console.warn('Customers load error (ignored):', cErr); }
    else { cust.forEach(c => customersById[c.id] = c); }
  }

  // 3) Fetch items for these orders
  const orderIds = orders.map(o => o.id);
  const { data: items, error: iErr } = await sb.from('order_items')
    .select('order_id, name, unit_price, qty')
    .in('order_id', orderIds);
  if (iErr) { console.warn('Items load error (ignored):', iErr); }

  // group items by order_id
  const itemsByOrder = {};
  (items || []).forEach(it => {
    (itemsByOrder[it.order_id] ||= []).push(it);
  });

  // stitch
  const merged = orders.map(o => ({
    ...o,
    customer: customersById[o.customer_id] || null,
    order_items: itemsByOrder[o.id] || []
  }));

  // client-side search
  const filtered = q
    ? merged.filter(o => {
        const n = (o.customer?.name || '').toLowerCase();
        const p = (o.customer?.phone || '').toLowerCase();
        return n.includes(q) || p.includes(q);
      })
    : merged;

  render(filtered);
}

function render(orders) {
  const empty = document.getElementById('empty');
  const list = document.getElementById('list');
  list.innerHTML = '';
  empty.classList.toggle('hidden', orders.length>0);

  orders.forEach(o=>{
    const a = o.address_snapshot || {};
    const card = document.createElement('div');
    card.className = 'bg-white border shadow rounded-2xl p-4';
    card.innerHTML = `
      <div class="flex flex-wrap items-start justify-between gap-3">
        <div>
          <div class="text-sm text-neutral-500">#${o.id.slice(0,8)} ‚Ä¢ ${new Date(o.created_at).toLocaleString('vi-VN')}</div>
          <div class="font-semibold mt-1">${o.customer?.name || '‚Äî'} ‚Ä¢ ${o.customer?.phone || ''}</div>
          <div class="text-sm text-neutral-600">${a.street||''}, ${a.ward||''}, ${a.district||''}, ${a.province||''}</div>
          ${o.note ? `<div class="text-sm mt-1 italic text-neutral-600">Note: ${o.note}</div>` : ''}
        </div>
        <div class="text-right">
          <div class="text-neutral-600 text-sm">Subtotal: ${money(o.subtotal)}</div>
          <div class="text-neutral-600 text-sm">Delivery: ${money(o.delivery_fee)}</div>
          <div class="font-semibold text-lg mt-1">Total: ${money(o.total)}</div>
          <div class="mt-1 inline-block text-xs px-2 py-1 rounded bg-neutral-100 border">${o.status}</div>
        </div>
      </div>
      <div class="mt-3 border-t pt-3 text-sm">
        <div class="font-medium mb-1">Items</div>
        <div class="grid gap-1">
          ${(o.order_items||[]).map(it=>`
            <div class="flex justify-between">
              <div class="truncate">${it.name}</div>
              <div class="shrink-0">${it.qty} √ó ${money(it.unit_price)}</div>
            </div>
          `).join('')}
        </div>
      </div>
    `;
    list.appendChild(card);
  });
}

// Export customers CSV
document.getElementById('exportCustomers').onclick = async ()=>{
  const { data, error } = await sb.from('customers').select('name,phone,created_at').order('created_at',{ascending:false});
  if (error) { console.error(error); alert('Export failed'); return; }
  const rows = [['name','phone','created_at'], ...data.map(r=>[r.name||'', r.phone||'', r.created_at||''])];
  const csv = rows.map(r => r.map(v => `"${String(v).replace(/"/g,'""')}"`).join(',')).join('\n');
  const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
  const url = URL.createObjectURL(blob);
  const a = Object.assign(document.createElement('a'), {href:url, download:'customers.csv'});
  document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
};

document.getElementById('q').addEventListener('input', load);
document.getElementById('dateFrom').addEventListener('change', load);
document.getElementById('dateTo').addEventListener('change', load);
load();
</script>
</body>
</html>
