<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin ‚Äî Orders</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    .chip{border-radius:9999px;padding:.35rem .8rem;border:1px solid #e5e7eb;background:#fff}
    .chip.active{background:#111;color:#fff;border-color:#111}
    @media print{
      body{background:#fff}
      .no-print{display:none!important}
    }
  </style>
</head>
<body class="bg-neutral-50 text-neutral-900">
  <div class="max-w-7xl mx-auto px-4 py-6">
    <div class="flex items-center justify-between">
      <h1 class="text-2xl font-bold">üì¶ Admin ‚Äî Orders</h1>
      <div class="no-print flex gap-2">
        <a href="./" class="px-3 py-2 rounded-lg border bg-white">‚Üê Storefront</a>
        <button id="exportOrders" class="px-3 py-2 rounded-lg bg-black text-white">Export CSV (full)</button>
      </div>
    </div>

    <div class="no-print mt-4 grid md:grid-cols-[1fr_180px_180px] gap-3">
      <input id="q" placeholder="Search name/phone‚Ä¶" class="border rounded-xl px-3 py-2 bg-white">
      <input id="dateFrom" type="date" class="border rounded-xl px-3 py-2 bg-white">
      <input id="dateTo"   type="date" class="border rounded-xl px-3 py-2 bg-white">
    </div>

    <!-- Status filter chips -->
    <div class="no-print mt-3 flex flex-wrap gap-2">
      <button data-st="all"       class="chip active">All</button>
      <button data-st="pending"   class="chip">Pending</button>
      <button data-st="paid"      class="chip">Paid</button>
      <button data-st="delivered" class="chip">Delivered</button>
    </div>

    <div id="list" class="mt-5 grid gap-4"></div>
    <p id="empty" class="hidden text-neutral-500 mt-10 text-center">No orders yet.</p>
  </div>

<script>
/* ==== CONFIG (change if needed) ==== */
const SUPABASE_URL = 'https://peenohpyubshzxgzzkhx.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBlZW5vaHB5dWJzaHp4Z3p6a2h4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg5OTczOTYsImV4cCI6MjA3NDU3MzM5Nn0.5PJYRCGyhM-E16yJrU5W_kBeDQgaJiine4j_cS9gKoU';
/* ================================== */

const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
const money = v => (v||0).toLocaleString('vi-VN') + ' ƒë';
let statusFilter = 'all';

async function load() {
  const q = document.getElementById('q').value.trim().toLowerCase();
  const from = document.getElementById('dateFrom').value;
  const to   = document.getElementById('dateTo').value;

  // 1) orders
  let oQuery = sb.from('orders')
    .select('id, created_at, status, subtotal, delivery_fee, total, note, address_snapshot, customer_id')
    .order('created_at', { ascending:false });
  if (from) oQuery = oQuery.gte('created_at', from);
  if (to)   oQuery = oQuery.lte('created_at', to + ' 23:59:59');
  if (statusFilter !== 'all') oQuery = oQuery.eq('status', statusFilter);

  const { data: orders, error: oErr } = await oQuery;
  if (oErr) { console.error(oErr); alert('Failed to load orders'); return; }
  if (!orders?.length) { render([]); return; }

  // 2) customers
  const customerIds = [...new Set(orders.map(o => o.customer_id).filter(Boolean))];
  const { data: cust } = await sb.from('customers').select('id,name,phone').in('id', customerIds);
  const customersById = Object.fromEntries((cust||[]).map(c=>[c.id,c]));

  // 3) items
  const orderIds = orders.map(o=>o.id);
  const { data: items } = await sb.from('order_items')
    .select('order_id,name,unit_price,qty')
    .in('order_id', orderIds);
  const itemsByOrder = {};
  (items||[]).forEach(it => (itemsByOrder[it.order_id] ||= []).push(it));

  // 4) marketing consent (yes/no per customer)
  const { data: consents } = await sb.from('marketing_consents')
    .select('customer_id')
    .in('customer_id', customerIds);
  const consentSet = new Set((consents||[]).map(c=>c.customer_id));

  // stitch
  const merged = orders.map(o => ({
    ...o,
    customer: customersById[o.customer_id] || null,
    order_items: itemsByOrder[o.id] || [],
    consent: consentSet.has(o.customer_id)
  }));

  // search
  const filtered = q
    ? merged.filter(o => {
        const n = (o.customer?.name || '').toLowerCase();
        const p = (o.customer?.phone || '').toLowerCase();
        const addr = JSON.stringify(o.address_snapshot||{}).toLowerCase();
        return n.includes(q) || p.includes(q) || addr.includes(q);
      })
    : merged;

  render(filtered);
}

function render(orders) {
  const empty = document.getElementById('empty');
  const list = document.getElementById('list');
  list.innerHTML = '';
  empty.classList.toggle('hidden', orders.length>0);

  orders.forEach(o=>{
    const a = o.address_snapshot || {};
    const card = document.createElement('div');
    card.className = 'bg-white border shadow rounded-2xl p-4';

    const itemsHtml = (o.order_items||[]).map(it=>`
      <div class="flex justify-between">
        <div class="truncate">${it.name}</div>
        <div class="shrink-0">${it.qty} √ó ${money(it.unit_price)}</div>
      </div>
    `).join('');

    const addrStr = [a.street,a.ward,a.district,a.province].filter(Boolean).join(', ');

    card.innerHTML = `
      <div class="flex flex-wrap items-start justify-between gap-3">
        <div>
          <div class="text-sm text-neutral-500">#${o.id.slice(0,8)} ‚Ä¢ ${new Date(o.created_at).toLocaleString('vi-VN')}</div>
          <div class="font-semibold mt-1">${o.customer?.name || '‚Äî'} ‚Ä¢ ${o.customer?.phone || ''}</div>
          <div class="text-sm text-neutral-600">${addrStr || ''}</div>
          ${o.note ? `<div class="text-sm mt-1 italic text-neutral-600">Note: ${o.note}</div>` : ''}
          <div class="text-xs mt-1 ${o.consent?'text-green-700':'text-neutral-500'}">
            ${o.consent ? '‚úì consent to promotions' : '‚Äî no marketing consent'}
          </div>
        </div>
        <div class="text-right">
          <div class="text-neutral-600 text-sm">Subtotal: ${money(o.subtotal)}</div>
          <div class="text-neutral-600 text-sm">Delivery: ${money(o.delivery_fee)}</div>
          <div class="font-semibold text-lg mt-1">Total: ${money(o.total)}</div>
          <div class="mt-1 inline-block text-xs px-2 py-1 rounded bg-neutral-100 border">${o.status}</div>
          <div class="no-print mt-2 flex flex-wrap gap-2 justify-end">
            <button class="px-3 py-1 rounded-lg border bg-white" data-act="copy">Copy address</button>
            <a class="px-3 py-1 rounded-lg border bg-white" target="_blank"
               href="https://www.google.com/maps/search/${encodeURIComponent(addrStr)}">Map</a>
            <button class="px-3 py-1 rounded-lg bg-black text-white" data-act="print">Print receipt</button>
            <button class="px-3 py-1 rounded-lg border bg-white" data-act="set:paid">Mark Paid</button>
            <button class="px-3 py-1 rounded-lg border bg-white" data-act="set:delivered">Delivered</button>
          </div>
        </div>
      </div>
      <div class="mt-3 border-t pt-3 text-sm">
        <div class="font-medium mb-1">Items</div>
        <div class="grid gap-1">${itemsHtml}</div>
      </div>
    `;

    // actions
    card.querySelectorAll('[data-act]').forEach(btn=>{
      btn.onclick = async () => {
        const act = btn.dataset.act;
        if (act === 'copy') {
          await navigator.clipboard.writeText(addrStr);
          btn.textContent='Copied!'; setTimeout(()=>btn.textContent='Copy address',1200);
        } else if (act === 'print') {
          printReceipt(o);
        } else if (act?.startsWith('set:')) {
          const newStatus = act.split(':')[1];
          btn.disabled = true;
          const { error } = await sb.from('orders').update({ status: newStatus }).eq('id', o.id);
          btn.disabled = false;
          if (error) { alert('Failed to update status'); console.error(error); }
          else load();
        }
      };
    });

    list.appendChild(card);
  });
}

/* ---- Print nice receipt into a popup and trigger browser print ---- */
function printReceipt(o){
  const a = o.address_snapshot || {};
  const items = o.order_items || [];
  const addrStr = [a.street,a.ward,a.district,a.province].filter(Boolean).join(', ');
  const itemsRows = items.map(it=>`
    <tr>
      <td style="padding:6px 0">${it.name}</td>
      <td style="text-align:center">${it.qty}</td>
      <td style="text-align:right">${money(it.unit_price)}</td>
      <td style="text-align:right">${money(it.unit_price*it.qty)}</td>
    </tr>
  `).join('');
  const wnd = window.open('', '_blank', 'width=420,height=600');
  wnd.document.write(`
    <html><head><title>Receipt ${o.id.slice(0,8)}</title>
    <style>
      body{font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;padding:20px}
      h1{font-size:18px;margin:0}
      .muted{color:#6b7280;font-size:12px}
      table{width:100%;border-collapse:collapse;margin-top:10px}
      td,th{font-size:14px;border-top:1px solid #eee;padding:6px 0}
      .totals td{font-weight:600}
      .badge{display:inline-block;border:1px solid #e5e7eb;border-radius:9999px;padding:2px 8px;font-size:12px}
      @media print {.no-print{display:none}}
    </style></head><body>
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h1>CAFE ‚Äî CACAO</h1>
        <span class="badge">${o.status}</span>
      </div>
      <div class="muted">Order #${o.id}</div>
      <div class="muted">${new Date(o.created_at).toLocaleString('vi-VN')}</div>

      <div style="margin-top:12px">
        <div><strong>${o.customer?.name || ''}</strong> ‚Ä¢ ${o.customer?.phone || ''}</div>
        <div class="muted">${addrStr}</div>
        ${o.note ? `<div class="muted">Note: ${a.note||o.note}</div>` : ''}
      </div>

      <table>
        <thead>
          <tr><th style="text-align:left">Item</th><th>Qty</th><th style="text-align:right">Price</th><th style="text-align:right">Amount</th></tr>
        </thead>
        <tbody>${itemsRows}</tbody>
        <tfoot>
          <tr class="totals"><td colspan="3" style="text-align:right">Subtotal</td><td style="text-align:right">${money(o.subtotal)}</td></tr>
          <tr class="totals"><td colspan="3" style="text-align:right">Delivery</td><td style="text-align:right">${money(o.delivery_fee)}</td></tr>
          <tr class="totals"><td colspan="3" style="text-align:right">Total</td><td style="text-align:right">${money(o.total)}</td></tr>
        </tfoot>
      </table>

      <p class="muted" style="margin-top:14px">Thanks for your order!</p>
      <button class="no-print" onclick="window.print()">Print</button>
    </body></html>
  `);
  wnd.document.close();
  wnd.focus();
  wnd.onload = () => wnd.print();
}

/* ---- Export CSV with all checkout details + items string ---- */
document.getElementById('exportOrders').onclick = async ()=>{
  const { data: orders, error: oErr } = await sb.from('orders')
    .select('id, created_at, status, subtotal, delivery_fee, total, note, address_snapshot, customer_id')
    .order('created_at', { ascending:false });
  if (oErr) { console.error(oErr); alert('Export failed (orders)'); return; }
  if (!orders?.length){ alert('No orders'); return; }

  const orderIds = orders.map(o=>o.id);
  const custIds  = [...new Set(orders.map(o=>o.customer_id).filter(Boolean))];

  const [{ data: cust }, { data: items }, { data: cons }] = await Promise.all([
    sb.from('customers').select('id,name,phone').in('id', custIds),
    sb.from('order_items').select('order_id,name,unit_price,qty').in('order_id', orderIds),
    sb.from('marketing_consents').select('customer_id')
  ]);

  const customersById = Object.fromEntries((cust||[]).map(c=>[c.id,c]));
  const consentSet = new Set((cons||[]).map(c=>c.customer_id));
  const itemsByOrder = {};
  (items||[]).forEach(it => (itemsByOrder[it.order_id] ||= []).push(it));

  const rows = [
    ['order_id','created_at','status','name','phone','street','ward','district','province','note','consent','subtotal','delivery_fee','total','items']
  ];

  orders.forEach(o=>{
    const a = o.address_snapshot || {};
    const c = customersById[o.customer_id] || {};
    const itemsString = (itemsByOrder[o.id]||[])
      .map(it => `${it.qty}x ${it.name} @ ${it.unit_price}`)
      .join(' | ');
    rows.push([
      o.id, o.created_at, o.status, c.name||'', c.phone||'',
      a.street||'', a.ward||'', a.district||'', a.province||'',
      o.note||a.note||'', consentSet.has(o.customer_id)?'yes':'no',
      o.subtotal, o.delivery_fee, o.total, itemsString
    ]);
  });

  const csv = rows.map(r => r.map(v => `"${String(v).replace(/"/g,'""')}"`).join(',')).join('\n');
  const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
  const url = URL.createObjectURL(blob);
  const a = Object.assign(document.createElement('a'), {href:url, download:'orders_full.csv'});
  document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
};

/* ---- Filters & inputs ---- */
document.getElementById('q').addEventListener('input', load);
document.getElementById('dateFrom').addEventListener('change', load);
document.getElementById('dateTo').addEventListener('change', load);

document.querySelectorAll('[data-st]').forEach(b=>{
  b.onclick = () => {
    document.querySelectorAll('[data-st]').forEach(x=>x.classList.remove('active'));
    b.classList.add('active');
    statusFilter = b.dataset.st;
    load();
  };
});

load();
</script>
</body>
</html>
