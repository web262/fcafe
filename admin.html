<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin ‚Äî Orders</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    .chip{border-radius:9999px;padding:.4rem .85rem;border:1px solid #e5e7eb;background:#fff}
    .chip.active{background:#111;color:#fff;border-color:#111}
    @media (max-width: 640px){ .chip{padding:.5rem .95rem} }
    @media print{ body{background:#fff} .no-print{display:none!important} }
  </style>
</head>
<body class="bg-neutral-50 text-neutral-900">

  <!-- Header -->
  <header class="max-w-7xl mx-auto px-4 py-5">
    <div class="flex items-center justify-between gap-3">
      <h1 class="text-2xl font-bold">üì¶ Admin ‚Äî Orders</h1>
      <div class="no-print flex gap-2">
        <a href="./" class="px-3 py-2 rounded-lg border bg-white hover:bg-neutral-50">‚Üê Storefront</a>
        <button id="exportOrders" class="px-3 py-2 rounded-lg bg-black text-white">Export CSV (full)</button>
      </div>
    </div>
  </header>

  <!-- Sticky filters -->
  <div class="no-print sticky top-0 z-40 bg-neutral-50/80 backdrop-blur border-y">
    <div class="max-w-7xl mx-auto px-4 py-3 grid gap-2 sm:grid-cols-[1fr_180px_180px]">
      <input id="q" placeholder="T√¨m t√™n/ƒëi·ªán tho·∫°i/ƒë·ªãa ch·ªâ/m√£ ƒë∆°n‚Ä¶" class="border rounded-xl px-3 py-2 bg-white">
      <div class="grid grid-cols-2 gap-2 sm:contents">
        <input id="dateFrom" type="date" class="border rounded-xl px-3 py-2 bg-white">
        <input id="dateTo"   type="date" class="border rounded-xl px-3 py-2 bg-white">
      </div>
      <div class="mt-2 sm:mt-0 flex flex-wrap gap-2">
        <button data-st="all"       class="chip active">All</button>
        <button data-st="pending"   class="chip">Pending</button>
        <button data-st="paid"      class="chip">Paid</button>
        <button data-st="delivered" class="chip">Delivered</button>
        <button data-st="cancelled" class="chip">Cancelled</button>
      </div>
    </div>
  </div>

  <!-- List -->
  <main class="max-w-7xl mx-auto px-4 py-5">
    <div id="list" class="grid gap-4"></div>
    <p id="empty" class="hidden text-neutral-500 mt-10 text-center">Ch∆∞a c√≥ ƒë∆°n h√†ng.</p>
  </main>

<script>
/* ========= CONFIG ========= */
const SUPABASE_URL  = 'https://peenohpyubshzxgzzkhx.supabase.co';
const SUPABASE_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBlZW5vaHB5dWJzaHp4Z3p6a2h4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg5OTczOTYsImV4cCI6MjA3NDU3MzM5Nn0.5PJYRCGyhM-E16yJrU5W_kBeDQgaJiine4j_cS9gKoU';
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

/* ========= Helpers ========= */
const money = v => (Number(v)||0).toLocaleString('vi-VN') + ' ƒë';
let statusFilter = 'all';

/* ========= Load data =========
   orders may have: id, code?, customer_name, phone, address, notes|note, payment_method, status, total_vnd, created_at
*/
async function load(){
  const q    = document.getElementById('q').value.trim().toLowerCase();
  const from = document.getElementById('dateFrom').value;
  const to   = document.getElementById('dateTo').value;

  // select all columns to avoid 400 when some are missing
  let oQuery = sb.from('orders').select('*').order('created_at', { ascending:false });
  if (from) oQuery = oQuery.gte('created_at', from);
  if (to)   oQuery = oQuery.lte('created_at', to + ' 23:59:59');
  if (statusFilter !== 'all') oQuery = oQuery.eq('status', statusFilter);

  const { data: orders, error: oErr } = await oQuery;
  if (oErr){ console.error(oErr); alert('T·∫£i ƒë∆°n h√†ng th·∫•t b·∫°i'); return; }
  if (!orders?.length){ render([]); return; }

  const orderIds = orders.map(o=>o.id);
  const { data: items } = await sb.from('order_items')
    .select('order_id, name_snapshot, price_vnd, qty, line_total_vnd')
    .in('order_id', orderIds);

  const itemsByOrder = {};
  (items||[]).forEach(it => (itemsByOrder[it.order_id] ||= []).push(it));

  const merged = orders.map(o => ({...o, order_items: itemsByOrder[o.id] || []}));

  // free-text search
  const filtered = q
    ? merged.filter(o=>{
        const hay = [
          o.customer_name||'', o.phone||'', o.address||'', o.code||'', o.id||''
        ].join(' ').toLowerCase();
        return hay.includes(q);
      })
    : merged;

  render(filtered);
}

/* ========= Render ========= */
function render(orders){
  const list = document.getElementById('list');
  const empty = document.getElementById('empty');
  list.innerHTML = '';
  empty.classList.toggle('hidden', orders.length>0);

  orders.forEach(o=>{
    const itemsHtml = (o.order_items||[]).map(it=>`
      <div class="flex justify-between text-sm">
        <div class="truncate">${it.name_snapshot}</div>
        <div class="shrink-0">${it.qty} √ó ${money(it.price_vnd)}</div>
      </div>
    `).join('');

    const subtotal = (o.order_items||[]).reduce((s,it)=> s + (it.line_total_vnd||0), 0);

    const card = document.createElement('div');
    card.className = 'bg-white border shadow-sm rounded-2xl p-4';
    card.innerHTML = `
      <div class="flex flex-wrap items-start justify-between gap-3">
        <div>
          <div class="text-sm text-neutral-500">#${o.code || (o.id||'').slice(0,8)} ‚Ä¢ ${new Date(o.created_at).toLocaleString('vi-VN')}</div>
          <div class="font-semibold mt-1">${o.customer_name || '‚Äî'} ‚Ä¢ ${o.phone || ''}</div>
          <div class="text-sm text-neutral-600">${o.address || ''}</div>
          ${(o.notes || o.note) ? `<div class="text-sm mt-1 italic text-neutral-600">Note: ${o.notes || o.note}</div>` : ''}
          <div class="text-xs mt-1 text-neutral-500">Thanh to√°n: ${o.payment_method || '‚Äî'}</div>
        </div>
        <div class="text-right">
          <div class="text-neutral-600 text-sm">T·∫°m t√≠nh: ${money(subtotal)}</div>
          <div class="font-semibold text-lg mt-1">T·ªïng: ${money(o.total_vnd)}</div>
          <div class="mt-1 inline-block text-xs px-2 py-1 rounded bg-neutral-100 border">${o.status}</div>
          <div class="no-print mt-2 flex flex-wrap gap-2 justify-end">
            <button class="px-3 py-1 rounded-lg border bg-white hover:bg-neutral-50" data-act="copy">Copy ƒë·ªãa ch·ªâ</button>
            <a class="px-3 py-1 rounded-lg border bg-white hover:bg-neutral-50" target="_blank"
               href="https://www.google.com/maps/search/${encodeURIComponent(o.address || '')}">B·∫£n ƒë·ªì</a>
            <button class="px-3 py-1 rounded-lg bg-black text-white" data-act="print">In h√≥a ƒë∆°n</button>
            <button class="px-3 py-1 rounded-lg border bg-white hover:bg-neutral-50" data-act="set:paid">ƒê√°nh d·∫•u Paid</button>
            <button class="px-3 py-1 rounded-lg border bg-white hover:bg-neutral-50" data-act="set:delivered">Delivered</button>
            <button class="px-3 py-1 rounded-lg border bg-white hover:bg-neutral-50 text-red-600" data-act="set:cancelled">Cancel</button>
          </div>
        </div>
      </div>

      <div class="mt-3 border-t pt-3">
        <div class="font-medium mb-1">M√≥n</div>
        <div class="grid gap-1">${itemsHtml}</div>
      </div>
    `;

    card.querySelectorAll('[data-act]').forEach(btn=>{
      btn.onclick = async ()=>{
        const act = btn.dataset.act;
        if (act === 'copy'){
          await navigator.clipboard.writeText(o.address || '');
          btn.textContent = 'ƒê√£ copy!'; setTimeout(()=>btn.textContent='Copy ƒë·ªãa ch·ªâ',1200);
        } else if (act === 'print'){
          printReceipt(o);
        } else if (act.startsWith('set:')){
          const newStatus = act.split(':')[1];
          btn.disabled = true;
          const { error } = await sb.from('orders').update({ status:newStatus }).eq('id', o.id);
          btn.disabled = false;
          if (error){ alert('C·∫≠p nh·∫≠t tr·∫°ng th√°i th·∫•t b·∫°i'); console.error(error); }
          else load();
        }
      };
    });

    list.appendChild(card);
  });
}

/* ========= Print ========= */
function printReceipt(o){
  const items = o.order_items || [];
  const rows = items.map(it=>`
    <tr>
      <td style="padding:6px 0">${it.name_snapshot}</td>
      <td style="text-align:center">${it.qty}</td>
      <td style="text-align:right">${money(it.price_vnd)}</td>
      <td style="text-align:right">${money((it.line_total_vnd)|| (it.price_vnd*it.qty))}</td>
    </tr>
  `).join('');
  const subtotal = items.reduce((s,it)=> s + (it.line_total_vnd||it.price_vnd*it.qty||0), 0);

  const wnd = window.open('', '_blank', 'width=420,height=620');
  wnd.document.write(`
    <html><head><title>Receipt ${o.code || (o.id||'').slice(0,8)}</title>
    <style>
      body{font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;padding:20px}
      h1{font-size:18px;margin:0}
      .muted{color:#6b7280;font-size:12px}
      table{width:100%;border-collapse:collapse;margin-top:10px}
      td,th{font-size:14px;border-top:1px solid #eee;padding:6px 0}
      .totals td{font-weight:600}
      .badge{display:inline-block;border:1px solid #e5e7eb;border-radius:9999px;padding:2px 8px;font-size:12px}
      @media print {.no-print{display:none}}
    </style></head><body>
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h1>CAFE ‚Äî CACAO</h1>
        <span class="badge">${o.status}</span>
      </div>
      <div class="muted">Order #${o.code || o.id}</div>
      <div class="muted">${new Date(o.created_at).toLocaleString('vi-VN')}</div>

      <div style="margin-top:12px">
        <div><strong>${o.customer_name || ''}</strong> ‚Ä¢ ${o.phone || ''}</div>
        <div class="muted">${o.address || ''}</div>
        ${(o.notes || o.note) ? `<div class="muted">Note: ${o.notes || o.note}</div>` : ''}
        <div class="muted">Thanh to√°n: ${o.payment_method || '‚Äî'}</div>
      </div>

      <table>
        <thead>
          <tr><th style="text-align:left">M√≥n</th><th>SL</th><th style="text-align:right">Gi√°</th><th style="text-align:right">Th√†nh ti·ªÅn</th></tr>
        </thead>
        <tbody>${rows}</tbody>
        <tfoot>
          <tr class="totals"><td colspan="3" style="text-align:right">T·∫°m t√≠nh</td><td style="text-align:right">${money(subtotal)}</td></tr>
          <tr class="totals"><td colspan="3" style="text-align:right">T·ªïng</td><td style="text-align:right">${money(o.total_vnd)}</td></tr>
        </tfoot>
      </table>

      <p class="muted" style="margin-top:14px">C·∫£m ∆°n b·∫°n ƒë√£ ƒë·∫∑t h√†ng!</p>
      <button class="no-print" onclick="window.print()">In</button>
    </body></html>
  `);
  wnd.document.close();
  wnd.focus();
  wnd.onload = () => wnd.print();
}

/* ========= Export CSV (code optional) ========= */
document.getElementById('exportOrders').onclick = async ()=>{
  const { data: orders, error: oErr } = await sb.from('orders').select('*').order('created_at', { ascending:false });
  if (oErr){ console.error(oErr); alert('Export th·∫•t b·∫°i (orders)'); return; }
  if (!orders?.length){ alert('Kh√¥ng c√≥ ƒë∆°n'); return; }

  const orderIds = orders.map(o=>o.id);
  const { data: items, error: iErr } = await sb.from('order_items')
    .select('order_id, name_snapshot, price_vnd, qty, line_total_vnd')
    .in('order_id', orderIds);
  if (iErr){ console.error(iErr); alert('Export th·∫•t b·∫°i (items)'); return; }

  const itemsByOrder = {};
  (items||[]).forEach(it => (itemsByOrder[it.order_id] ||= []).push(it));

  const hasCode = orders.some(o => 'code' in o);
  const header = hasCode
    ? ['order_id','code','created_at','status','customer_name','phone','address','notes','payment_method','total_vnd','items']
    : ['order_id','created_at','status','customer_name','phone','address','notes','payment_method','total_vnd','items'];

  const rows = [header];

  orders.forEach(o=>{
    const parts = (itemsByOrder[o.id]||[]).map(it=>`${it.qty}x ${it.name_snapshot} @ ${it.price_vnd}`).join(' | ');
    const base = [
      o.id,
      o.created_at, o.status, o.customer_name||'', o.phone||'',
      o.address||'', (o.notes||o.note||''), o.payment_method||'', o.total_vnd||0, parts
    ];
    if (hasCode) base.splice(1,0,(o.code||'')); // insert code after id
    rows.push(base);
  });

  const csv = rows.map(r => r.map(v => `"${String(v).replace(/"/g,'""')}"`).join(',')).join('\n');
  const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
  const url  = URL.createObjectURL(blob);
  const a = Object.assign(document.createElement('a'), {href:url, download:'orders_export.csv'});
  document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
};

/* ========= Filters ========= */
document.getElementById('q').addEventListener('input', load);
document.getElementById('dateFrom').addEventListener('change', load);
document.getElementById('dateTo').addEventListener('change', load);
document.querySelectorAll('[data-st]').forEach(b=>{
  b.onclick = ()=>{
    document.querySelectorAll('[data-st]').forEach(x=>x.classList.remove('active'));
    b.classList.add('active');
    statusFilter = b.dataset.st;
    load();
  };
});

/* Boot */
load();
</script>

</body>
</html>
