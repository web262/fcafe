<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin — Menu Manager | CAFE — CACAO</title>

  <!-- Inline favicon to avoid net::ERR_NAME_NOT_RESOLVED -->
  <link rel="icon" href='data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><rect width="100" height="100" rx="18" fill="%23000"/><text x="50" y="62" font-size="60" text-anchor="middle" fill="%23fff" font-family="Inter,Arial">C</text></svg>'>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root{ --muted:#64748b; }
    body{
      color:#111827;
      background:
        radial-gradient(1200px 500px at -10% -20%, #FFE8A3 0, #FFE8A3 25%, transparent 60%),
        radial-gradient(900px 450px at 110% 0%, #FF8FAB40 0, transparent 60%),
        linear-gradient(180deg, #FFF 0, #FFF9F0 100%);
    }
    .card{transition:transform .18s ease, box-shadow .18s ease}
    .card:hover{transform:translateY(-2px); box-shadow:0 16px 34px rgba(0,0,0,.08)}
    .btn{padding:.5rem .75rem;border:1px solid rgba(15,23,42,.12);border-radius:.75rem;background:#fff}
    .btn-black{background:#000;color:#fff;border-color:#000}
    .chip{border-radius:.75rem;padding:.35rem .6rem;border:1px solid rgba(15,23,42,.12);}
  </style>
</head>
<body>

  <header class="sticky top-0 z-40 border-b bg-white/80 backdrop-blur">
    <div class="max-w-6xl mx-auto px-4 h-14 flex items-center justify-between">
      <div class="font-semibold">CAFE — CACAO • Menu Manager</div>
      <div class="flex gap-2">
        <a href="./admin.html" class="btn">Orders</a>
        <button id="btnSignOut" class="btn btn-black">Sign out</button>
      </div>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-4 py-5">
    <div class="flex flex-wrap items-center gap-3">
      <div class="flex items-center gap-2 w-full sm:w-auto flex-1">
        <input id="q" placeholder="Search name/category/sub…" class="border rounded-xl px-3 py-2 bg-white w-full min-w-[240px]">
        <button id="btnClear" class="btn hidden">Clear</button>
      </div>
      <button id="btnAdd" class="btn btn-black">+ Add item</button>
    </div>

    <div id="grid" class="mt-4 grid sm:grid-cols-2 lg:grid-cols-3 gap-4"></div>
    <p id="empty" class="hidden text-center text-neutral-500 mt-10">No items.</p>

    <!-- skeleton -->
    <div id="sk" class="grid sm:grid-cols-2 lg:grid-cols-3 gap-4">
      <div class="rounded-2xl border p-3 bg-white animate-pulse h-56"></div>
      <div class="rounded-2xl border p-3 bg-white animate-pulse h-56"></div>
      <div class="rounded-2xl border p-3 bg-white animate-pulse h-56"></div>
    </div>
  </main>

  <!-- Modal -->
  <dialog id="editDlg" class="rounded-2xl p-0 w-[min(560px,95vw)]">
    <form id="productForm" method="dialog" class="p-4 bg-white space-y-3">
      <h3 id="dlgTitle" class="text-lg font-semibold">Add product</h3>
      <input type="hidden" name="id">

      <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
        <div>
          <label class="text-sm">Name (VI)</label>
          <input name="name_vi" required class="w-full border rounded-xl px-3 py-2">
        </div>
        <div>
          <label class="text-sm">Name (EN)</label>
          <input name="name_en" class="w-full border rounded-xl px-3 py-2">
        </div>
        <div>
          <label class="text-sm">Category</label>
          <input name="category" class="w-full border rounded-xl px-3 py-2">
        </div>
        <div>
          <label class="text-sm">Subcategory</label>
          <input name="subcategory" class="w-full border rounded-xl px-3 py-2">
        </div>
        <div>
          <label class="text-sm">Price (VND)</label>
          <input name="price_vnd" type="number" min="0" step="1000" required class="w-full border rounded-xl px-3 py-2">
        </div>
        <div>
          <label class="text-sm">Size (optional)</label>
          <input name="size" class="w-full border rounded-xl px-3 py-2">
        </div>
      </div>

      <div>
        <label class="text-sm">Description (VI)</label>
        <textarea name="description_vi" rows="2" class="w-full border rounded-xl px-3 py-2"></textarea>
      </div>

      <div class="grid sm:grid-cols-[1fr_auto] gap-3 items-end">
        <div>
          <label class="text-sm">Image URL</label>
          <input name="image_url" class="w-full border rounded-xl px-3 py-2">
        </div>
        <div>
          <label class="text-sm">Upload</label>
          <input id="fileInput" type="file" accept="image/*" class="block">
        </div>
      </div>

      <div class="flex items-center justify-between pt-2">
        <div class="flex items-center gap-2">
          <input id="is_available" name="is_available" type="checkbox" checked>
          <label for="is_available">Available</label>
        </div>
        <div class="flex gap-2">
          <button id="btnDelete" class="btn">Delete</button>
          <button class="btn btn-black">Save</button>
        </div>
      </div>
    </form>
  </dialog>

<script>
/* ====== Supabase ====== */
const SUPABASE_URL  = 'https://peenohpyubshzxgzzkhx.supabase.co';
const SUPABASE_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBlZW5vaHB5dWJzaHp4Z3p6a2h4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg5OTczOTYsImV4cCI6MjA3NDU3MzM5Nn0.5PJYRCGyhM-E16yJrU5W_kBeDQgaJiine4j_cS9gKoU';
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

/* ====== Auth guard ====== */
const ADMIN_EMAILS = ['shivammishra.id@gmail.com'];

function renderLoginUI(){
  document.body.innerHTML = `
  <main class="min-h-screen grid place-items-center p-6 bg-gradient-to-b from-white to-amber-50">
    <div class="w-full max-w-md bg-white border rounded-2xl p-6 shadow-sm">
      <h1 class="text-xl font-semibold">Admin Login</h1>
      <form id="loginForm" class="mt-4 space-y-3">
        <input type="email" name="email" required placeholder="Email" class="w-full border rounded-xl px-3 py-2">
        <input type="password" name="password" required placeholder="Password" class="w-full border rounded-xl px-3 py-2">
        <button class="w-full bg-black text-white rounded-xl py-2">Sign in</button>
      </form>
    </div>
  </main>`;
  const f = document.getElementById('loginForm');
  f.onsubmit = async (e)=>{
    e.preventDefault();
    const { error } = await sb.auth.signInWithPassword({
      email: f.email.value.trim(),
      password: f.password.value
    });
    if (error){ alert(`Đăng nhập thất bại: ${error.message}`); return; }
    location.reload();
  };
}

async function requireAdmin(){
  const { data: { user } } = await sb.auth.getUser();
  if (!user){ renderLoginUI(); throw new Error('not signed in'); }
  const ok = ADMIN_EMAILS.includes((user.email||'').toLowerCase());
  if (!ok){ document.body.innerHTML = '<main class="p-8">No access.</main>'; throw new Error('not admin'); }
  return user;
}

/* ====== State / helpers ====== */
const $  = s => document.querySelector(s);
const grid = $('#grid'), empty = $('#empty'), sk = $('#sk');
const dlg = $('#editDlg'), form = $('#productForm');
const qInput = $('#q'), btnClear = $('#btnClear');
let PRODUCTS = [];
let FILTER = '';

const money = v => (Number(v)||0).toLocaleString('vi-VN') + ' VND';

/* Reset stale search and wire search box */
qInput.value = '';
btnClear.classList.add('hidden');
qInput.addEventListener('input', () => {
  FILTER = (qInput.value || '').trim().toLowerCase();
  btnClear.classList.toggle('hidden', FILTER === '');
  render();
});
btnClear.addEventListener('click', () => {
  qInput.value = '';
  FILTER = '';
  btnClear.classList.add('hidden');
  render();
});

function buildBasePayload() {
  return {
    name_vi: (form.name_vi.value || '').trim(),
    name_en: (form.name_en.value || '').trim() || null,
    category: (form.category.value || '').trim() || null,
    subcategory: (form.subcategory.value || '').trim() || null,
    price_vnd: Number(form.price_vnd.value) || 0,
    size: (form.size.value || '').trim() || null,
    description_vi: (form.description_vi.value || '').trim() || null,
    image_url: (form.image_url.value || '').trim() || null,
    is_available: $('#is_available').checked
  };
}

function toLegacyPayload(p){
  const q = { ...p };
  if ('name_vi' in q){ q.name = q.name_vi; delete q.name_vi; }
  if ('description_vi' in q){ q.description = q.description_vi; delete q.description_vi; }
  if ('price_vnd' in q){ q.price = q.price_vnd; delete q.price_vnd; }
  if ('is_available' in q){ q.is_active = q.is_available; delete q.is_available; }
  return q;
}

function isColumnMissing(err){
  return err && (
    err.code === '42703' ||
    err.code === 'PGRST204' ||
    /column .* does not exist/i.test(err.message||'') ||
    /could not find the .* column/i.test(err.message||'')
  );
}

function extractMissingColumn(err){
  const m1 = (err.message||'').match(/'([^']+)'\s+column/i);
  if (m1 && m1[1]) return m1[1];
  const m2 = (err.message||'').match(/column\s+"?([a-zA-Z0-9_]+)"?\s+does not exist/i);
  if (m2 && m2[1]) return m2[1];
  return null;
}

/* Save with schema fallback + pruning */
async function saveProduct({ id, base }) {
  let payload = { ...base };
  let triedLegacy = false;

  for (let attempt = 0; attempt < 8; attempt++) {
    let res;
    if (id) res = await sb.from('products').update(payload).eq('id', id);
    else    res = await sb.from('products').insert(payload);

    if (!res.error) return { ok: true };

    const err = res.error;

    if (!triedLegacy && isColumnMissing(err)) {
      payload = toLegacyPayload(payload);
      triedLegacy = true;
      continue;
    }
    if (isColumnMissing(err)) {
      const col = extractMissingColumn(err);
      if (col && (col in payload)) {
        delete payload[col];
        continue;
      }
    }
    return { ok:false, error: err };
  }
  return { ok:false, error: { message:'Too many retries' } };
}

/* ====== Load & Render ====== */
async function load(){
  sk.classList.remove('hidden');
  const { data, error } = await sb.from('products')
    .select('*')
    .order('sort_order', { ascending:true })
    .order('name_vi', { ascending:true })
    .order('created_at', { ascending:false });
  if (error){ console.error(error); alert('Load products failed'); sk.classList.add('hidden'); return; }
  PRODUCTS = data || [];
  render();
}

function pickName(p){ return p.name_vi || p.name || p.name_en || '(no name)'; }

function render(){
  const list = FILTER
    ? PRODUCTS.filter(p=>{
        const hay = [p.name_vi,p.name,p.name_en,p.category,p.subcategory].join(' ').toLowerCase();
        return hay.includes(FILTER);
      })
    : PRODUCTS;

  grid.innerHTML = '';
  empty.classList.toggle('hidden', list.length>0);
  sk.classList.add('hidden');

  list.forEach(p=>{
    const price = (p.price_vnd!=null) ? p.price_vnd : (p.price||0);
    const card = document.createElement('div');
    card.className = 'card bg-white border rounded-2xl p-3';
    card.innerHTML = `
      <div class="rounded-xl overflow-hidden h-36 bg-neutral-100">
        ${p.image_url ? `<img src="${p.image_url}" class="w-full h-full object-cover" alt="">` : ''}
      </div>
      <div class="mt-2 font-semibold flex items-center gap-2">
        ${(!p.is_available && p.is_available !== undefined) ? `<span class="chip text-xs">hidden</span>` : ''}
        <span>${pickName(p)}</span>
      </div>
      <div class="text-sm text-neutral-600">${p.category||''} ${p.subcategory?('• '+p.subcategory):''}</div>
      <div class="mt-1 font-medium">${money(price)}</div>
      <div class="mt-2 flex gap-2">
        <button class="btn" data-edit="${p.id}">Edit</button>
        <button class="btn" data-del="${p.id}">Delete</button>
      </div>
    `;
    grid.appendChild(card);
  });

  // EDIT
  grid.querySelectorAll('[data-edit]').forEach(b=>{
    b.onclick = ()=> openEditor(b.dataset.edit);
  });

  // DELETE (inlined logic to avoid any scope issues)
  grid.querySelectorAll('[data-del]').forEach(b=>{
    b.onclick = async ()=>{
      const id = b.dataset.del;
      if (!id) return;
      if (!confirm('Delete this item?')) return;
      const { error } = await sb.from('products').delete().eq('id', id);
      if (error){ alert('Delete failed: ' + error.message); console.error(error); return; }
      await load();
    };
  });
}

/* ====== Editor ====== */
function openEditor(id){
  form.reset();
  document.getElementById('dlgTitle').textContent = id ? 'Edit product' : 'Add product';
  document.getElementById('btnDelete').style.display = id ? 'inline-flex' : 'none';

  if (id){
    const p = PRODUCTS.find(x => String(x.id) === String(id));
    if (p){
      form.id.value = p.id;
      form.name_vi.value = p.name_vi || p.name || '';
      form.name_en.value = p.name_en || '';
      form.category.value = p.category || '';
      form.subcategory.value = p.subcategory || '';
      form.price_vnd.value = (p.price_vnd!=null) ? p.price_vnd : (p.price||0);
      form.size.value = p.size || '';
      form.description_vi.value = p.description_vi || p.description || '';
      form.image_url.value = p.image_url || '';
      document.getElementById('is_available').checked =
        ('is_available' in p) ? !!p.is_available : (('is_active' in p) ? !!p.is_active : true);
    }
  }
  dlg.showModal();
}

/* ====== Save (insert/update) ====== */
form.onsubmit = async (e)=>{
  e.preventDefault();

  // upload first if a file chosen (bucket must exist and be public)
  const file = document.getElementById('fileInput').files[0];
  if (file){
    const filename = `${crypto.randomUUID()}_${file.name.replace(/\s+/g,'_')}`;
    const { error:upErr } = await sb.storage.from('product-images').upload(filename, file);
    if (upErr){ alert('Upload failed: ' + upErr.message); console.error(upErr); return; }
    const { data:pub } = sb.storage.from('product-images').getPublicUrl(filename);
    form.image_url.value = pub.publicUrl;
  }

  const base = buildBasePayload();
  const id = form.id.value || null;

  const result = await saveProduct({ id, base });

  if (!result.ok){
    alert('Update failed: ' + (result.error?.message || 'unknown'));
    console.error(result.error);
    return;
  }

  // Clear the filter so a just-created/renamed item isn't hidden
  qInput.value = ''; FILTER = ''; btnClear.classList.add('hidden');

  dlg.close();
  await load();
};

// Footer delete in dialog
document.getElementById('btnDelete').onclick = async (e)=>{
  e.preventDefault();
  if (!form.id.value) return;
  if (!confirm('Delete this item?')) return;
  const { error } = await sb.from('products').delete().eq('id', form.id.value);
  if (error){ alert('Delete failed: ' + error.message); console.error(error); return; }
  dlg.close();
  await load();
};

/* ====== Misc events ====== */
document.getElementById('btnAdd').onclick = ()=> openEditor();
document.getElementById('btnSignOut').onclick = async ()=>{ await sb.auth.signOut(); location.reload(); };

/* ====== Realtime auto-refresh ====== */
let channel;
function subscribeRealtime(){
  // Listen to inserts/updates/deletes on products and refresh the grid
  channel = sb.channel('realtime-products')
    .on('postgres_changes',
        { event: '*', schema: 'public', table: 'products' },
        async () => { await load(); })
    .subscribe();
}
window.addEventListener('beforeunload', ()=>{ if (channel) sb.removeChannel(channel); });

/* ====== Boot ====== */
(async function boot(){
  try {
    await requireAdmin();
    subscribeRealtime();
    await load();
  } catch(err){
    console.warn(err);
  }
})();
</script>
</body>
</html>
