<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin — Menu Manager | CAFE — CACAO</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root{ --muted:#64748b; }
    body{
      color:#111827;
      background:
        radial-gradient(1200px 500px at -10% -20%, #FFE8A3 0, #FFE8A3 25%, transparent 60%),
        radial-gradient(900px 450px at 110% 0%, #FF8FAB40 0, transparent 60%),
        linear-gradient(180deg, #FFF 0, #FFF9F0 100%);
    }
    .card{transition:transform .18s ease, box-shadow .18s ease}
    .card:hover{transform:translateY(-2px); box-shadow:0 16px 34px rgba(0,0,0,.08)}
    .btn{padding:.5rem .75rem;border:1px solid rgba(15,23,42,.12);border-radius:.75rem;background:#fff}
    .btn-black{background:#000;color:#fff;border-color:#000}
    .glass{backdrop-filter:saturate(130%) blur(10px); background:rgba(255,255,255,.6)}
  </style>
</head>
<body>

  <header class="sticky top-0 z-40 border-b bg-white/80 backdrop-blur">
    <div class="max-w-6xl mx-auto px-4 h-14 flex items-center justify-between">
      <div class="font-semibold">CAFE — CACAO • Menu Manager</div>
      <div class="flex gap-2">
        <a href="./admin.html" class="btn">Orders</a>
        <button id="btnSignOut" class="btn btn-black">Sign out</button>
      </div>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-4 py-5">
    <div class="flex flex-wrap items-center gap-3">
      <div class="flex gap-2 items-center w-full sm:w-auto flex-1">
        <input id="q" placeholder="Search name/category/sub…" class="border rounded-xl px-3 py-2 bg-white flex-1 min-w-[240px]">
        <button id="btnClear" class="btn">Clear</button>
      </div>
      <button id="btnAdd" class="btn btn-black">+ Add item</button>
    </div>

    <div id="grid" class="mt-4 grid sm:grid-cols-2 lg:grid-cols-3 gap-4"></div>
    <p id="empty" class="hidden text-center text-neutral-500 mt-10">No items.</p>

    <!-- skeleton -->
    <div id="sk" class="grid sm:grid-cols-2 lg:grid-cols-3 gap-4">
      <div class="rounded-2xl border p-3 bg-white animate-pulse h-56"></div>
      <div class="rounded-2xl border p-3 bg-white animate-pulse h-56"></div>
      <div class="rounded-2xl border p-3 bg-white animate-pulse h-56"></div>
    </div>
  </main>

  <!-- Modal -->
  <dialog id="editDlg" class="rounded-2xl p-0 w-[min(560px,95vw)]">
    <form id="productForm" method="dialog" class="p-4 bg-white space-y-3">
      <h3 id="dlgTitle" class="text-lg font-semibold">Add product</h3>
      <input type="hidden" name="id">

      <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
        <div>
          <label class="text-sm">Name (VI)</label>
          <input name="name_vi" required class="w-full border rounded-xl px-3 py-2">
        </div>
        <div>
          <label class="text-sm">Name (EN)</label>
          <input name="name_en" class="w-full border rounded-xl px-3 py-2">
        </div>
        <div>
          <label class="text-sm">Category</label>
          <input name="category" class="w-full border rounded-xl px-3 py-2">
        </div>
        <div>
          <label class="text-sm">Subcategory</label>
          <input name="subcategory" class="w-full border rounded-xl px-3 py-2">
        </div>
        <div>
          <label class="text-sm">Price (VND)</label>
          <input name="price_vnd" type="number" min="0" step="1000" required class="w-full border rounded-xl px-3 py-2">
        </div>
        <div>
          <label class="text-sm">Size (optional)</label>
          <input name="size" class="w-full border rounded-xl px-3 py-2">
        </div>
      </div>

      <div>
        <label class="text-sm">Description (VI)</label>
        <textarea name="description_vi" rows="2" class="w-full border rounded-xl px-3 py-2"></textarea>
      </div>

      <div class="grid sm:grid-cols-[1fr_auto] gap-3 items-end">
        <div>
          <label class="text-sm">Image URL</label>
          <input name="image_url" class="w-full border rounded-xl px-3 py-2">
        </div>
        <div>
          <label class="text-sm">Upload</label>
          <input id="fileInput" type="file" accept="image/*" class="block">
        </div>
      </div>

      <div class="flex items-center justify-between pt-2">
        <div class="flex items-center gap-2">
          <input id="is_available" name="is_available" type="checkbox" checked>
          <label for="is_available">Available</label>
        </div>
        <div class="flex gap-2">
          <button id="btnDelete" class="btn">Delete</button>
          <button class="btn btn-black">Save</button>
        </div>
      </div>
    </form>
  </dialog>

<script>
/* ====== Supabase ====== */
const SUPABASE_URL  = 'https://peenohpyubshzxgzzkhx.supabase.co';
const SUPABASE_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBlZW5vaHB5dWJzaHp4Z3p6a2h4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg5OTczOTYsImV4cCI6MjA3NDU3MzM5Nn0.5PJYRCGyhM-E16yJrU5W_kBeDQgaJiine4j_cS9gKoU';
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

/* ====== Auth guard ====== */
const ADMIN_EMAILS = ['shivammishra.id@gmail.com'];

function renderLoginUI(){
  document.body.innerHTML = `
  <main class="min-h-screen grid place-items-center p-6 bg-gradient-to-b from-white to-amber-50">
    <div class="w-full max-w-md bg-white border rounded-2xl p-6 shadow-sm">
      <h1 class="text-xl font-semibold">Admin Login</h1>
      <form id="loginForm" class="mt-4 space-y-3">
        <input type="email" name="email" required placeholder="Email" class="w-full border rounded-xl px-3 py-2">
        <input type="password" name="password" required placeholder="Password" class="w-full border rounded-xl px-3 py-2">
        <button class="w-full bg-black text-white rounded-xl py-2">Sign in</button>
      </form>
    </div>
  </main>`;
  const f = document.getElementById('loginForm');
  f.onsubmit = async (e)=>{
    e.preventDefault();
    const { error } = await sb.auth.signInWithPassword({
      email: f.email.value.trim(),
      password: f.password.value
    });
    if (error){ alert(`Đăng nhập thất bại: ${error.message}`); return; }
    location.reload();
  };
}

async function requireAdmin(){
  const { data: { user } } = await sb.auth.getUser();
  if (!user){ renderLoginUI(); throw new Error('not signed in'); }
  const ok = ADMIN_EMAILS.includes((user.email||'').toLowerCase());
  if (!ok){ document.body.innerHTML = '<main class="p-8">No access.</main>'; throw new Error('not admin'); }
  return user;
}

/* ====== State / helpers ====== */
const $  = s => document.querySelector(s);
const grid = $('#grid'), empty = $('#empty'), sk = $('#sk');
const dlg = $('#editDlg'), form = $('#productForm');
let PRODUCTS = [];
let FILTER = '';

const money = v => (Number(v)||0).toLocaleString('vi-VN') + ' VND';
const pickName = p => p.name_vi || p.name || p.name_en || '(no name)';

/* ========= CRUD helpers ========= */

function buildBasePayload() {
  return {
    name_vi: (form.name_vi.value || '').trim(),
    name_en: (form.name_en.value || '').trim() || null,
    category: (form.category.value || '').trim() || null,
    subcategory: (form.subcategory.value || '').trim() || null,
    price_vnd: Number(form.price_vnd.value) || 0,
    size: (form.size.value || '').trim() || null,
    description_vi: (form.description_vi.value || '').trim() || null,
    image_url: (form.image_url.value || '').trim() || null,
    is_available: $('#is_available').checked
  };
}

// Legacy column mapping (for older rows)
const toLegacyPayload = (p) => {
  const q = { ...p };
  if ('name_vi' in q){ q.name = q.name_vi; delete q.name_vi; }
  if ('description_vi' in q){ q.description = q.description_vi; delete q.description_vi; }
  if ('price_vnd' in q){ q.price = q.price_vnd; delete q.price_vnd; }
  if ('is_available' in q){ q.is_active = q.is_available; delete q.is_available; }
  return q;
};

const isMissingColumn = err =>
  err && (err.code === '42703' || err.code === 'PGRST204' ||
         /column .* does not exist/i.test(err.message||'') ||
         /could not find the .* column/i.test(err.message||''));

const extractMissingCol = err => {
  const m1 = (err.message||'').match(/'([^']+)'\s+column/i);
  if (m1 && m1[1]) return m1[1];
  const m2 = (err.message||'').match(/column\s+"?([a-zA-Z0-9_]+)"?\s+does not exist/i);
  return (m2 && m2[1]) || null;
};

// Insert/update that survives old schemas by pruning unknown cols
async function saveProduct({ id, payload }) {
  let body = { ...payload };
  let triedLegacy = false;
  for (let i=0;i<8;i++){
    let res = id
      ? await sb.from('products').update(body).eq('id', id)
      : await sb.from('products').insert(body);

    if (!res.error) return { ok:true };

    // map to legacy just once
    if (!triedLegacy && isMissingColumn(res.error)){
      body = toLegacyPayload(body);
      triedLegacy = true;
      continue;
    }
    // prune the exact missing column if any
    if (isMissingColumn(res.error)){
      const col = extractMissingCol(res.error);
      if (col && col in body){ delete body[col]; continue; }
    }
    return { ok:false, error:res.error };
  }
  return { ok:false, error:{message:'Too many retries'} };
}

/* ========= Load / Render ========= */

async function load(){
  sk.classList.remove('hidden');
  const { data, error } = await sb.from('products')
    .select('*')
    .order('sort_order', { ascending:true })
    .order('name_vi', { ascending:true });
  if (error){ console.error(error); alert('Load products failed'); sk.classList.add('hidden'); return; }
  PRODUCTS = data || [];
  render();
}

function render(){
  const q = FILTER.trim().toLowerCase();
  const list = !q ? PRODUCTS : PRODUCTS.filter(p=>{
    const hay = [p.name_vi,p.name,p.name_en,p.category,p.subcategory].join(' ').toLowerCase();
    return hay.includes(q);
  });

  grid.innerHTML = '';
  empty.classList.toggle('hidden', list.length>0);
  sk.classList.add('hidden');

  list.forEach(p=>{
    const price = (p.price_vnd!=null) ? p.price_vnd : (p.price||0);
    const card = document.createElement('div');
    card.className = 'card bg-white border rounded-2xl p-3';
    const badge = ('is_available' in p ? !p.is_available : ('is_active' in p ? !p.is_active : false))
      ? '<span class="ml-2 text-xs px-2 py-0.5 rounded bg-yellow-100 border border-yellow-300">archived</span>' : '';
    card.innerHTML = `
      <div class="rounded-xl overflow-hidden h-36 bg-neutral-100">
        ${p.image_url ? `<img src="${p.image_url}" class="w-full h-full object-cover" loading="lazy">` : ''}
      </div>
      <div class="mt-2 font-semibold">${pickName(p)} ${badge}</div>
      <div class="text-sm text-neutral-600">${p.category||''} ${p.subcategory?('• '+p.subcategory):''}</div>
      <div class="mt-1 font-medium">${money(price)}</div>
      <div class="mt-2 flex gap-2">
        <button class="btn" data-edit="${p.id}">Edit</button>
        <button class="btn" data-del="${p.id}">Delete</button>
      </div>
    `;
    grid.appendChild(card);
  });

  grid.querySelectorAll('[data-edit]').forEach(b=> b.onclick = ()=> openEditor(b.dataset.edit));
  grid.querySelectorAll('[data-del]').forEach(b=> b.onclick = ()=> delItem(b.dataset.del));
}

/* ========= Editor ========= */

function openEditor(id){
  form.reset();
  $('#dlgTitle').textContent = id ? 'Edit product' : 'Add product';
  $('#btnDelete').style.display = id ? 'inline-flex' : 'none';

  if (id){
    const p = PRODUCTS.find(x => String(x.id) === String(id));
    if (p){
      form.id.value = p.id;
      form.name_vi.value = p.name_vi || p.name || '';
      form.name_en.value = p.name_en || '';
      form.category.value = p.category || '';
      form.subcategory.value = p.subcategory || '';
      form.price_vnd.value = (p.price_vnd!=null) ? p.price_vnd : (p.price||0);
      form.size.value = p.size || '';
      form.description_vi.value = p.description_vi || p.description || '';
      form.image_url.value = p.image_url || '';
      $('#is_available').checked = ('is_available' in p) ? !!p.is_available :
                                   (('is_active' in p) ? !!p.is_active : true);
    }
  }
  dlg.showModal();
}

/* ========= Save ========= */

form.onsubmit = async (e)=>{
  e.preventDefault();

  // optional image upload
  const file = $('#fileInput').files[0];
  if (file){
    const filename = `${crypto.randomUUID()}_${file.name.replace(/\s+/g,'_')}`;
    const { error:upErr } = await sb.storage.from('product-images').upload(filename, file);
    if (upErr){ alert('Upload failed: ' + upErr.message); console.error(upErr); return; }
    const { data:pub } = sb.storage.from('product-images').getPublicUrl(filename);
    form.image_url.value = pub.publicUrl;
  }

  const payload = buildBasePayload();
  const id = form.id.value || null;

  const result = await saveProduct({ id, payload });

  if (!result.ok){
    alert('Update failed: ' + (result.error?.message || 'unknown'));
    console.error(result.error);
    return;
  }

  dlg.close();
  // optimistic: let realtime update, but also refresh in case RLS hides mutations
  await load();
};

document.getElementById('btnDelete').onclick = async (e)=>{
  e.preventDefault();
  if (!form.id.value) return;
  delItem(form.id.value);
};

/* ========= Delete (safe) ========= */

async function delItem(id){
  if (!confirm('Delete this item?')) return;

  // First try hard delete.
  let res = await sb.from('products').delete().eq('id', id);

  // If FK blocks deletion, archive instead (soft delete).
  if (res.error){
    const msg = (res.error.message||'').toLowerCase();
    const blocked = res.status === 409 || res.error.code === '23503' || msg.includes('foreign key');
    if (blocked){
      if (!confirm('This item is used by existing orders.\nArchive it instead (hide from menu)?')) return;
      const { error:upErr } = await sb.from('products').update({ is_available:false, is_active:false }).eq('id', id);
      if (upErr){ alert('Archive failed: ' + upErr.message); console.error(upErr); return; }
    } else {
      alert('Delete failed: ' + res.error.message);
      console.error(res.error);
      return;
    }
  }

  await load();
}

/* ========= Events ========= */
document.getElementById('btnAdd').onclick = ()=> openEditor();
document.getElementById('btnSignOut').onclick = async ()=>{ await sb.auth.signOut(); location.reload(); };
document.getElementById('btnClear').onclick = ()=>{ $('#q').value=''; FILTER=''; render(); };
document.getElementById('q').addEventListener('input', e=>{ FILTER = e.target.value; render(); });

/* ========= Realtime sync ========= */
// Any insert/update/delete to products will refresh the list.
// (Make sure Database → Replication → Realtime is enabled for the `public` schema in Supabase)
const channel = sb.channel('products-live')
  .on('postgres_changes', { event: '*', schema: 'public', table: 'products' }, async () => {
    await load();
  })
  .subscribe();

/* ========= Boot ========= */
(async function boot(){
  try {
    await requireAdmin();
    await load();
  } catch(err){
    console.warn(err);
  }
})();
</script>
</body>
</html>

